# [1-3] PBI-1 End-to-End Verification

[Back to task list](./tasks.md)

## Description

Execute and document the PBI-level verification for Project Foundation & Database Schema. Confirm build, migration idempotency, full table availability, JSON function behavior, and runtime startup behavior against PBI acceptance criteria.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 09:15:55 | Created | N/A | Agreed | Task created from user request to implement PBI 1 | AI_Agent |
| 2026-02-18 09:44:20 | Status Change | Agreed | InProgress | Started E2E verification | AI_Agent |
| 2026-02-18 09:45:48 | Status Change | InProgress | Review | Verification complete, internal AI review passed (4 low findings, all deferred) | AI_Agent |
| 2026-02-18 09:53:53 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Execute quality checks and integration tests defined by tasks 1-1 and 1-2.
2. Verify database file creation at configured `DATABASE_PATH`.
3. Verify migrations are idempotent by running startup twice.
4. Verify all acceptance criteria have clear pass/fail evidence in this task file.
5. Capture verification command outputs and failure modes.

## Implementation Plan

1. Run quality checks (`make check`) and capture results.
2. Run startup commands with temporary database path and observe logs.
3. Validate schema and JSON behavior through integration tests.
4. Document acceptance criteria evidence and edge-case behavior.

## Test Plan

- Execute all tests and static checks from previous tasks.
- Run binary twice against the same SQLite path to confirm migration idempotency.
- Confirm FTS5 table existence.
- Confirm structured logs and database health behavior.

## Verification

### PBI Acceptance Criteria Evidence

**AC1: `go build ./cmd/apollo` produces a binary without errors**
- PASS. `go build -o /tmp/apollo-test-binary ./cmd/apollo` completed with exit code 0.

**AC2: Binary starts, connects to SQLite, and runs migrations idempotently**
- PASS. First run: migration applied, structured JSON logs emitted, exit code 0.
- PASS. Second run against same DB: no "migration applied" log (already applied), exit code 0.
- `schema_migrations` table contains exactly 1 record after both runs.

**AC3: All 11 tables from PRD section 10 exist with correct columns, types, and foreign keys**
- PASS. `sqlite3 .tables` output confirms: `topics`, `modules`, `lessons`, `concepts`, `concept_references`, `topic_prerequisites`, `topic_relations`, `expansion_queue`, `research_jobs`, `learning_progress`, `concept_retention`, plus `schema_migrations` and `search_index` (FTS5).
- Foreign keys enforced: inserting a module with nonexistent `topic_id` produces FK violation error (tested in `TestForeignKeysEnforced`).

**AC4: JSON columns store and retrieve valid JSON (verified with `json_extract()`)**
- PASS. Inserted topic with tags `["a","b"]`, `json_extract(tags,'$[1]')` returned `b`.
- `json_valid()` CHECK constraints on all JSON columns in schema.

**AC5: FTS5 virtual table created for full-text search across topics, lessons, and concepts**
- PASS. `search_index` table exists as FTS5 virtual table (confirmed by `sqlite_master` SQL definition containing `fts5`). FTS5 internal tables (`search_index_data`, `search_index_config`, etc.) present.

**AC6: Configuration loads from env vars with defaults matching PRD section 15**
- PASS. Default run shows: `server_port: 8080`, `max_research_depth: 3`, `max_parallel_agents: 3`, `topic_size_limit: 8`, `auto_expand_priority: essential`, `curriculum_stale_days: 180`, `mastery_threshold_days: 90`.
- Env override verified: `SERVER_PORT=9090` and `DATABASE_PATH` override reflected in log output.

**AC7: Structured JSON logging works via zerolog**
- PASS. All log output is valid JSON with fields: `level`, `service`, `time`, `message`, plus contextual fields.

**AC8: Database file created at configured `DATABASE_PATH`**
- PASS. Setting `DATABASE_PATH=/tmp/apollo-e2e-env/override.db` created the directory and file at that path.

### Quality Checks

- `make check` (fmt, vet, test): ALL PASS
- Coverage: config 83.3%, database 68.0%, logging 100%
- Database coverage at 68% due to internal error paths in pragma application and migration file reading that require DB-level mocking. Core functionality (Open, migrate, schema, JSON, FTS5, FK enforcement, idempotency, nil Handle) thoroughly tested.

## Files Modified

- `docs/delivery/1/1-3.md` (this file â€” verification evidence)
- `docs/delivery/1/tasks.md` (status update)
