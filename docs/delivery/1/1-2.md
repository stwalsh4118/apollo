# [1-2] SQLite Schema and Migration Engine

[Back to task list](./tasks.md)

## Description

Implement the SQLite data layer for all PRD section 10 entities using embedded SQL migrations. Ensure migrations are idempotent, tracked, and executed automatically during startup before serving application behavior.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 09:15:55 | Created | N/A | Agreed | Task created from user request to implement PBI 1 | AI_Agent |
| 2026-02-18 09:20:41 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 09:44:20 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 09:53:53 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add SQLite driver and DB opening logic with foreign keys enabled.
2. Add embedded migration runner with an applied-migrations tracking table.
3. Create migration SQL for all 11 PRD section 10 tables and FTS5 index.
4. Ensure JSON columns can be queried using SQLite JSON functions.
5. Add DB health check and failure propagation from startup path.

## Implementation Plan

1. Create internal DB package with open, migrate, and healthcheck responsibilities.
2. Embed SQL files via `embed.FS` and apply ordered migrations inside a transaction.
3. Create `schema_migrations` tracking table and implement idempotency guard.
4. Add full base schema SQL file with constraints, foreign keys, and indexes.
5. Integrate DB initialization into the application startup path.

**External Packages**: This task requires research and a guide document for: `modernc.org/sqlite`

## Test Plan

- Unit tests for migration runner idempotency.
- Integration test that opens a temp DB, runs migrations, and validates key tables exist.
- Validation test for JSON extraction (for example, `json_extract(tags, '$[0]')`).
- `go test ./...` and `go build ./cmd/apollo` pass.

## Verification

- `make check` (in `api/`) passed (`go fmt`, `go vet`, `go test`).
- All 11 PRD tables + `schema_migrations` + `search_index` FTS5 verified to exist.
- JSON extraction (`json_extract(tags, '$[0]')`) verified working.
- Migrations are idempotent â€” double `Open()` produces exactly 1 migration record.
- Foreign keys enforced via DSN pragma parameters (survive pool recycling).
- Error-path tests pass: invalid path, nil Handle close, FK violation, FTS5 type check.
- Internal AI review gate passed after fixing: DSN pragmas (high), unused constant (medium), error tests (medium), migration comment (medium), directory permissions (medium).

## Files Modified

- `api/go.mod`
- `api/go.sum`
- `api/migrations/embed.go`
- `api/migrations/0001_initial_schema.sql`
- `api/internal/database/database.go`
- `api/internal/database/migrations.go`
- `api/internal/database/database_test.go`
- `api/cmd/apollo/main.go`
- `docs/delivery/1/1-2-modernc-sqlite-guide.md`
- `docs/delivery/1/1-2.md`
- `docs/delivery/1/tasks.md`
