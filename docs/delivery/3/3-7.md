# [3-7] Code section renderer with Shiki

[Back to task list](./tasks.md)

## Description

Implement the code content section renderer using Shiki for syntax highlighting. The renderer handles `type: "code"` sections with syntax highlighting for at least bash, json, yaml, go, javascript, and typescript. Includes a copy-to-clipboard button and language label.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:34:02 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 14:02:49 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 14:10:50 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 04:40:46 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Code renderer** (`type: "code"`):
   - Renders `code` field with Shiki syntax highlighting
   - Supports languages: `bash`, `json`, `yaml`, `go`, `javascript`, `typescript` (minimum)
   - Displays optional `title` above the code block
   - Displays `explanation` text below the code block (if present)
   - Shows `language` label in the header
2. Copy-to-clipboard button:
   - Copies raw code text to clipboard
   - Visual feedback on copy (icon change or tooltip)
3. Shiki integration:
   - Use a bundled theme (e.g., `github-dark` or similar)
   - Lazy-load highlighter to avoid blocking initial render
   - Fallback to `<pre><code>` if highlighting fails
4. Performance: highlight asynchronously, show unhighlighted code while loading

## Implementation Plan

1. Install `shiki`
2. Create research guide: `3-7-shiki-guide.md`
3. Create `web/src/components/content/CodeSection.tsx`
4. Create `web/src/hooks/useShikiHighlighter.ts` — lazy Shiki initialisation
5. Implement copy-to-clipboard with visual feedback
6. Register `CodeSection` in the content dispatcher from task 3-6
7. Verify highlighting for all 6 required languages

**External Packages**: This task requires research and a guide document for: `shiki`

## Test Plan

### Objectives
Verify Shiki renders syntax-highlighted code correctly with copy functionality.

### Key Scenarios
1. Code block with `language: "go"` renders with Go syntax highlighting
2. Code block with `title` displays title above the block
3. Code block with `explanation` shows text below
4. Copy button copies code to clipboard
5. Language label shows in code block header
6. Unknown language falls back to plain text rendering
7. Shiki load failure falls back to `<pre><code>`
8. All 6 required languages render (bash, json, yaml, go, javascript, typescript)

## Verification

- [x] `pnpm lint` passes
- [x] `pnpm build` passes (tsc + vite)
- [x] Internal AI review: pass (0 critical, 0 high, 1 medium, 4 low)
- [x] Medium finding addressed: added trust boundary comment for dangerouslySetInnerHTML
- [x] Low finding addressed: reset cached promise on createHighlighter failure

## Files Modified

- `web/src/hooks/useShikiHighlighter.ts` — **New**: Lazy Shiki singleton with cached result pattern
- `web/src/components/content/CodeSection.tsx` — **New**: Code block renderer with copy button
- `web/src/components/content/ContentRenderer.tsx` — **Modified**: Added `case "code"` dispatch
- `docs/delivery/3/3-7-shiki-guide.md` — **New**: Shiki research guide
