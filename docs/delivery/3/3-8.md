# [3-8] Diagram renderer with Mermaid.js

[Back to task list](./tasks.md)

## Description

Implement the diagram content section renderer using Mermaid.js. The renderer handles `type: "diagram"` sections where `format` is `"mermaid"`, rendering the diagram from the `source` field. Includes error fallback for invalid Mermaid syntax.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 13:34:02 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 14:11:14 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 14:14:22 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 04:40:46 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Diagram renderer** (`type: "diagram"`):
   - When `format` is `"mermaid"`: render `source` field using Mermaid.js
   - When `format` is `"image"`: render as `<img>` (delegate to image renderer pattern)
   - Display `title` above the diagram
2. Mermaid integration:
   - Initialise Mermaid with sensible defaults (theme matching app)
   - Render diagrams into inline SVG
   - Each diagram renders independently (unique IDs)
3. Error fallback:
   - If Mermaid parse fails, display the raw `source` in a `<pre>` block with an error message
   - Do not crash the page on malformed diagram source

## Implementation Plan

1. Install `mermaid`
2. Create research guide: `3-8-mermaid-guide.md`
3. Create `web/src/components/content/DiagramSection.tsx`
4. Create `web/src/hooks/useMermaid.ts` — Mermaid initialisation and rendering
5. Implement error boundary/fallback for parse failures
6. Register `DiagramSection` in the content dispatcher from task 3-6
7. Test with various Mermaid diagram types (flowchart, sequence, class)

**External Packages**: This task requires research and a guide document for: `mermaid`

## Test Plan

### Objectives
Verify Mermaid diagrams render correctly with proper error handling.

### Key Scenarios
1. Valid Mermaid flowchart renders as SVG
2. Valid Mermaid sequence diagram renders as SVG
3. Diagram `title` displays above the rendered diagram
4. Invalid Mermaid source shows error fallback with raw source
5. `format: "image"` renders as an `<img>` element
6. Multiple diagrams on the same page render independently
7. Mermaid initialisation failure does not crash the page

## Verification

- [x] `pnpm lint` passes
- [x] `pnpm build` passes (tsc + vite)
- [x] Internal AI review: pass (0 critical, 0 high, 1 medium, 6 low)
- [x] Medium finding addressed: generate fresh ID per effect invocation to avoid Mermaid render ID collisions
- [x] Low finding addressed: cache dynamic import promise for mermaid module

## Files Modified

- `web/src/hooks/useMermaid.ts` — **New**: Lazy Mermaid singleton with unique render IDs
- `web/src/components/content/DiagramSection.tsx` — **New**: Diagram renderer (mermaid + image formats)
- `web/src/components/content/ContentRenderer.tsx` — **Modified**: Added `case "diagram"` dispatch
- `docs/delivery/3/3-8-mermaid-guide.md` — **New**: Mermaid.js research guide
