# [4-2] Progress repository

[Back to task list](./tasks.md)

## Description

Implement the data access layer for the `learning_progress` table. Provides CRUD operations used by the progress API handlers.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 05:11:17 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create `ProgressRepository` interface in `api/internal/repository/progress.go`:
   - `GetTopicProgress(ctx, topicID) (*models.TopicProgress, error)` — query all lessons in a topic via module join, LEFT JOIN on learning_progress to include not_started lessons
   - `UpdateLessonProgress(ctx, lessonID, input) (*models.LessonProgress, error)` — upsert into learning_progress (INSERT OR REPLACE); auto-set `started_at` on first non-not_started status, `completed_at` on completed status
   - `GetProgressSummary(ctx) (*models.ProgressSummary, error)` — aggregate query: total lessons, completed count, completion %, count of distinct topics with at least one in_progress/completed lesson

2. Create concrete implementation `progressRepository` backed by `*sql.DB`
3. Constructor: `NewProgressRepository(db *sql.DB) ProgressRepository`
4. Use existing sentinel errors from `repository/errors.go` for not-found cases
5. Validate that the lesson exists before upserting progress (return `ErrNotFound` if missing)

## Implementation Plan

1. Create `api/internal/repository/progress.go` with interface and implementation
2. Write unit tests in `api/internal/repository/progress_test.go` using the existing `testhelper_test.go` setup

## Test Plan

- Test `GetTopicProgress` returns all lessons with default `not_started` status when no progress rows exist
- Test `UpdateLessonProgress` creates a new row and returns the updated progress
- Test `UpdateLessonProgress` updates an existing row (upsert)
- Test `UpdateLessonProgress` returns `ErrNotFound` for a non-existent lesson
- Test `GetProgressSummary` returns correct aggregate counts
- Test `completed_at` is auto-set when status changes to `completed`

## Verification

_To be completed during implementation._

## Files Modified

- `api/internal/repository/progress.go` (new)
- `api/internal/repository/progress_test.go` (new)
