# [16-4] E2E CoS Test — Schema Compliance Pipeline

[Back to task list](./tasks.md)

## Description

End-to-end test verifying the full sanitize → assemble pipeline produces 0 schema validation errors. Uses fixture directory trees with known schema violations to confirm the sanitizer corrects them before assembly. This is the final validation that PBI 16's Conditions of Satisfaction are met.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 13:13:28 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create an E2E test in `api/internal/research/` that:
   - Builds a fixture directory tree representing a small curriculum (1 topic, 2 modules, 3-4 lessons) with intentional schema violations:
     - Extra fields on ConceptTaught (`slug`, `description`)
     - Extra fields on ConceptReferenced (`slug`, `reason`)
     - Extra fields on Example (`concepts`)
     - Missing optional-but-common extra fields the agent tends to add
   - Runs `SanitizeDir` on the fixture tree
   - Runs `AssembleFromDir` on the sanitized tree
   - Asserts 0 errors from both functions
   - Asserts the assembled `CurriculumOutput` is valid (non-nil, correct number of modules/lessons)
2. Create a second test case with a clean fixture tree (no violations):
   - Runs `SanitizeDir` → `AssembleFromDir`
   - Asserts 0 errors
   - Asserts output matches input (no unintended modifications)
3. Verify all existing tests pass: `make check` exits 0.

## Implementation Plan

1. Create test fixtures programmatically in `t.TempDir()` following the directory structure: `topic.json`, `modules/01-*/module.json`, `modules/01-*/01-*.json`.
2. Write `TestSanitizeAndAssemble_WithViolations` — fixture with extra fields → sanitize → assemble → assert success.
3. Write `TestSanitizeAndAssemble_CleanFixture` — valid fixture → sanitize → assemble → assert success and no modification.
4. Run `make check` to verify no regressions.

## Test Plan

### Objectives
Validate the complete PBI 16 Conditions of Satisfaction end-to-end.

### Key Scenarios

| # | Scenario | Expected |
|---|----------|----------|
| 1 | Fixture with extra fields on concepts, examples | SanitizeDir strips extras; AssembleFromDir succeeds with 0 errors |
| 2 | Clean fixture with no violations | Both functions succeed; assembled output structurally correct |
| 3 | Existing test suite | `make check` passes with 0 failures |

### Success Criteria
- All E2E test scenarios pass.
- `make check` exits 0.
- Assembled CurriculumOutput from violated fixture has correct module/lesson counts.

### Conditions of Satisfaction Verification

| CoS | Verification |
|-----|-------------|
| System prompt includes explicit schema type definitions | Verified in 16-1 |
| Go sanitizer strips unknown fields | Verified in 16-2 unit tests + this E2E test |
| Sanitizer logs warnings for stripped fields | Verified in 16-2 unit tests |
| Sanitizer returns error for missing required fields | Verified in 16-2 unit tests |
| Orchestrator calls sanitizer between pass 4 and assembly | Verified in 16-3 |
| Full pipeline run produces 0 schema errors after sanitization | **Verified in this test** |
| All existing tests pass | **Verified by `make check`** |
| Sanitizer has unit tests | Verified in 16-2 |

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
