# [16-2] Implement SanitizeDir Function with Unit Tests

[Back to task list](./tasks.md)

## Description

Create a Go sanitizer function (`SanitizeDir`) that walks the research output file tree and enforces schema compliance before assembly. The sanitizer strips fields not defined in the curriculum schema, logs warnings for each stripped field (file path + field name via zerolog), and returns an error for missing required fields that cannot be auto-fixed. Files are modified in place.

This is the programmatic safety net described in the PRD — it runs in milliseconds, costs zero API credits, and catches any residual drift the prompt improvements (16-1) don't eliminate.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 13:13:28 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create `api/internal/research/sanitizer.go` with:
   - `func SanitizeDir(workDir string) error` — public entry point
   - Schema field definitions for each file type: topic.json fields, module.json fields, lesson file fields, and all nested object types (ConceptTaught, ConceptReferenced, Example, Exercise, ReviewQuestion, ContentSection variants, Assessment, Flashcard, Prerequisites, PrerequisiteItem)
   - Directory tree walking: read topic.json, iterate module dirs, iterate lesson files
   - For each JSON file: unmarshal to `map[string]interface{}`, strip unknown fields recursively, check required fields, write back
   - Log warnings via zerolog for each stripped field: include file path and field name
   - Return descriptive error for missing required fields (include file path, object type, field name)
2. Create `api/internal/research/sanitizer_test.go` with tests covering:
   - Extra field stripping: file with unknown fields → fields removed, warning logged
   - Missing required field detection: file missing a required field → error returned
   - Clean file passthrough: valid file → unchanged after sanitization
   - Nested object sanitization: extra fields on ConceptTaught, Example, Exercise objects stripped correctly
3. The sanitizer must handle all nested types defined in `schemas/curriculum.json` `$defs`.
4. Use existing project patterns: zerolog for logging, `os.ReadFile`/`os.WriteFile` for I/O.
5. Do NOT modify any existing files — this task only creates new files.

## Implementation Plan

1. Define allowed fields per type as Go maps (`map[string]bool`) keyed by JSON field name. Source of truth: `schemas/curriculum.json`.
   - Topic-level fields (matches CurriculumOutput minus `modules` plus `module_plan`)
   - ModulePlan entry fields
   - Module-level fields (matches Module minus `lessons`)
   - Lesson-level fields
   - All nested types: ConceptTaught, Flashcard, ConceptReferenced, Example, Exercise, ReviewQuestion, ContentSection variants (keyed by `type` field), Assessment, AssessmentQuestion, Prerequisites, PrerequisiteItem
2. Implement recursive sanitization: given a `map[string]interface{}` and a type spec (allowed fields + required fields + nested type specs), strip unknown keys and recurse into nested objects/arrays.
3. Implement `SanitizeDir`:
   - Read and sanitize `topic.json` (topic-level schema + module_plan array)
   - Walk `modules/` subdirectories
   - For each module dir: sanitize `module.json` (module-level schema + assessment)
   - For each lesson file: sanitize with lesson-level schema (content sections, concepts, examples, exercises, review questions)
   - Write back modified files only if changes were made
4. Write unit tests using `t.TempDir()` for isolated test directories.

## Test Plan

### Objectives
Verify the sanitizer correctly strips unknown fields, detects missing required fields, and passes clean files through unchanged.

### Test Scope
- Unit tests only; no integration with assembler or orchestrator.

### Key Scenarios

| # | Scenario | Input | Expected |
|---|----------|-------|----------|
| 1 | Extra fields on lesson | Lesson JSON with `slug`, `summary` extra fields | Fields removed; warning logged; no error |
| 2 | Extra fields on ConceptTaught | Concept with `slug`, `description` extra fields | Fields removed; concept retains `id`, `name`, `definition`, `flashcard` |
| 3 | Extra fields on Example | Example with `concepts` extra field | Field removed; example retains `title`, `description`, `code`, `explanation` |
| 4 | Missing required field | Lesson JSON missing `estimated_minutes` | Error returned naming the missing field |
| 5 | Clean lesson passthrough | Valid lesson JSON with no extra fields | File unchanged; no warnings; no error |
| 6 | Clean topic passthrough | Valid topic.json | File unchanged; no error |
| 7 | Module with assessment | Module.json with valid assessment | Assessment sanitized correctly (questions checked) |
| 8 | ContentSection variants | Code section with extra field | Extra field stripped; `type`, `language`, `code`, `explanation` retained |

### Success Criteria
- All 8+ test scenarios pass.
- `go test ./api/internal/research/ -run TestSanitize` exits 0.

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
