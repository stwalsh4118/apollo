# [6-5] CLI Session Spawner

[Back to task list](./tasks.md)

## Description

Implement an `exec.Command` wrapper for spawning Claude Code CLI sessions. Handles flag construction for initial and resume passes, stdout capture, JSON response parsing, session ID extraction, and process lifecycle management (timeout, cancellation via context). This is the low-level interface between the Go orchestrator and the Claude Code CLI.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:51:13 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:52:08 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 08:29:09 | Status Change | Review | Done | All tasks verified, preparing PR | AI_Agent |

## Requirements

1. **CLISession** (`api/internal/research/cli.go`):
   - `RunInitialPass(ctx, opts InitialPassOpts) (*CLIResponse, error)` — spawns CLI for Pass 1:
     ```
     claude -p "topic brief" \
       --system-prompt-file ./skills/research.md \
       --output-format json \
       --model opus \
       --allowedTools "WebSearch,WebFetch,Read,Write"
     ```
   - `RunResumePass(ctx, opts ResumePassOpts) (*CLIResponse, error)` — spawns CLI for Passes 2-4:
     ```
     claude -p "pass instructions" \
       --resume $SESSION_ID \
       --output-format json
     ```
     - For Pass 4 (final), also add: `--json-schema ./schemas/curriculum.json`
   - Both methods capture stdout, parse as `CLIResponse` JSON, extract `session_id`

2. **Options types**:
   - `InitialPassOpts`: `Prompt`, `WorkDir`, `SystemPromptFile`, `Model`, `AllowedTools []string`
   - `ResumePassOpts`: `Prompt`, `SessionID`, `WorkDir`, `JSONSchemaFile` (optional, for final pass)

3. **Process management**:
   - Use `exec.CommandContext` for cancellation support via context
   - Set working directory via `Cmd.Dir`
   - Capture both stdout and stderr
   - Return structured error if process exits non-zero (include stderr in error)

4. **JSON response parsing**:
   - Parse stdout as `CLIResponse` (defined in Task 6-1)
   - Extract `session_id` for subsequent `--resume` calls
   - Extract `structured_output` from final pass response
   - Handle malformed JSON gracefully (return error with raw output snippet)

5. **Interface for testing**:
   - Define a `CLIRunner` interface so the orchestrator can be tested with a mock:
     ```go
     type CLIRunner interface {
         RunInitialPass(ctx context.Context, opts InitialPassOpts) (*CLIResponse, error)
         RunResumePass(ctx context.Context, opts ResumePassOpts) (*CLIResponse, error)
     }
     ```

## Implementation Plan

1. Create `api/internal/research/cli.go` with `CLIRunner` interface and `CLISession` implementation.
2. Implement flag construction for initial and resume passes per PRD section 6.3.
3. Implement stdout capture and JSON parsing.
4. Implement context-based cancellation.
5. Create `api/internal/research/cli_test.go` — test flag construction and JSON parsing (mock the actual CLI binary).

**External Packages**: None — uses only `os/exec` and `encoding/json` from stdlib.

## Test Plan

- **Flag construction (initial)**: Verify correct flags built for Pass 1 (`-p`, `--system-prompt-file`, `--output-format json`, `--model`, `--allowedTools`).
- **Flag construction (resume)**: Verify correct flags for Passes 2-3 (`-p`, `--resume`, `--output-format json`).
- **Flag construction (final)**: Verify Pass 4 includes `--json-schema` flag.
- **JSON parsing**: Verify `CLIResponse` correctly parsed from sample JSON, session_id extracted.
- **Error handling**: Verify non-zero exit code returns error with stderr content.
- **Malformed JSON**: Verify graceful error with output snippet when stdout isn't valid JSON.
- **Context cancellation**: Verify process killed when context cancelled.

## Verification

- 7 tests pass: initial args, minimal args, resume args, final pass args, JSON parsing, structured output parsing, error response parsing
- CLIRunner interface defined for mock injection
- Flag construction tested for all pass types
- `make check` passes

## Files Modified

- `api/internal/research/cli.go` — Created: CLIRunner interface, CLISession implementation, InitialPassOpts, ResumePassOpts, BuildInitialArgs, BuildResumeArgs, parseCLIResponse
- `api/internal/research/cli_test.go` — Created: 7 tests for flag construction and JSON parsing
