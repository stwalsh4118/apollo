# [6-3] Research API Handlers

[Back to task list](./tasks.md)

## Description

Implement HTTP handlers for the research job API endpoints (PRD section 9.1) and wire them into the chi router. Create the research API specification document. These endpoints allow creating research jobs, listing jobs, checking status/progress, and cancelling running jobs.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:44:46 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:48:11 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 08:29:09 | Status Change | Review | Done | All tasks verified, preparing PR | AI_Agent |

## Requirements

1. **ResearchHandler** (`api/internal/handler/research.go`):
   - `POST /api/research` — create a new research job
     - Body: `{ "topic": "string", "brief": "optional string" }`
     - Response: 201 with created `ResearchJob` JSON
     - Validation: topic is required, non-empty
   - `GET /api/research/jobs` — list all research jobs
     - Query params: `?page=`, `?per_page=` (pagination)
     - Response: 200 with `PaginatedResponse[ResearchJobSummary]`
   - `GET /api/research/jobs/{id}` — get job status and progress
     - Response: 200 with full `ResearchJob` JSON
     - 404 if not found
   - `POST /api/research/jobs/{id}/cancel` — cancel a running job
     - Response: 200 with updated `ResearchJob`
     - 404 if not found
     - 400 if job is already in a terminal state (`published`, `failed`, `cancelled`)

2. **Server wiring** (`api/internal/server/server.go`):
   - Create `ResearchHandler` with repository dependency
   - Register routes on the chi router
   - Note: The handler accepts a `StartResearchFunc` callback (or channel) that the orchestrator (Task 6-7) will provide. For now, creating a job just inserts it as `queued` — the orchestrator picks it up.

3. **API specification** (`docs/api-specs/research/research-api.md`):
   - Document all endpoints, request/response shapes, error codes
   - Update `docs/api-specs/README.md` to include the new spec

4. **Follow existing handler patterns**:
   - Use `respond.JSON()` and `respond.Error()` for responses
   - Use `chi.URLParam()` for path parameters
   - Use `models.ParsePagination()` for pagination
   - Max request body 2 MB

## Implementation Plan

1. Create `api/internal/handler/research.go` with handler struct, constructor, and `RegisterRoutes`.
2. Implement each endpoint method following existing handler patterns (see `write.go`, `progress.go`).
3. Wire into `server.go` router.
4. Create `docs/api-specs/research/research-api.md`.
5. Update `docs/api-specs/README.md`.
6. Create `api/internal/handler/research_test.go`.

## Test Plan

- **POST /api/research**: Verify 201 with valid body, 400 with missing/empty topic, response contains job ID and `queued` status.
- **GET /api/research/jobs**: Verify paginated list, empty list returns empty items array.
- **GET /api/research/jobs/{id}**: Verify 200 for existing job, 404 for missing.
- **POST /api/research/jobs/{id}/cancel**: Verify status changes to `cancelled`, 404 for missing, 400 for already-terminal job.
- **Server wiring**: Verify routes registered and accessible.

## Verification

- All 10 handler tests pass (create, create missing topic, create bad JSON, list, list empty, get, get not found, cancel, cancel not found, cancel terminal)
- Server integration tests pass
- `make check` passes
- Cancel ordering fixed: DB status update before cancel signal

## Files Modified

- `api/internal/handler/research.go` — Created: ResearchHandler with 4 endpoints, CancelFunc type
- `api/internal/handler/research_test.go` — Created: 10 handler tests with mock repository
- `api/internal/server/server.go` — Updated: added cancelResearchFn field, SetCancelResearchFunc method, research handler wiring
- `docs/api-specs/research/research-api.md` — Created: full API specification
- `docs/api-specs/README.md` — Updated: added research spec to index
