# [6-8] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end tests verifying all PBI 6 acceptance criteria. Uses a mocked CLI runner to simulate the full research pipeline from API request through to curriculum storage and retrieval.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 09:10:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 09:17:24 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 08:29:09 | Status Change | Review | Done | All tasks verified, preparing PR | AI_Agent |

## Requirements

Verify all 10 acceptance criteria from the PBI:

1. **AC1**: `POST /api/research` creates a research job and returns job ID
2. **AC2**: Orchestrator spawns CLI session with correct flags per PRD 6.3
3. **AC3**: Multi-turn pipeline executes 4 passes via `--resume`
4. **AC4**: Structured JSON output parsed and validated against schema
5. **AC5**: Curriculum stored in SQLite: topic, modules, lessons, concepts, flashcards, prerequisites
6. **AC6**: Research job progress updates during execution (current pass, modules, concepts)
7. **AC7**: `GET /api/research/jobs/:id` returns accurate status and progress
8. **AC8**: Failed research sessions produce a `failed` job with error details
9. **AC9**: Cancel endpoint stops a running research session
10. **AC10**: End-to-end: submit a topic, research completes, curriculum browsable via PBI 2 API

## Implementation Plan

1. Create `test/integration/research_e2e_test.go` (or `api/internal/research/e2e_test.go`).
2. Set up test infrastructure: in-memory SQLite DB, mock CLI runner with canned responses, full server with real handlers and repositories.
3. Implement test scenarios covering all 10 acceptance criteria.
4. Use a realistic sample curriculum JSON (valid against schema) for the mock CLI's final pass response.

## Test Plan

### Environment & Setup
- In-memory SQLite with migrations applied
- Mock `CLIRunner` that returns pre-built `CLIResponse` objects
- Real repositories, real handlers, real orchestrator (with mocked CLI)
- HTTP test server for API endpoint testing

### Test Scenarios

**Scenario 1: Full Happy Path (AC1, AC2, AC3, AC4, AC5, AC6, AC7, AC10)**
1. POST /api/research with `{ "topic": "test-topic" }` → verify 201, job ID returned
2. Trigger orchestrator to process the job
3. Verify mock CLI runner called 4 times (1 initial + 3 resume passes)
4. Verify initial pass called with correct flags (--system-prompt-file, --output-format json, --model opus, --allowedTools)
5. Verify resume passes called with correct session_id and --resume flag
6. Verify final pass includes --json-schema flag
7. GET /api/research/jobs/:id → verify status `published`, progress shows 4/4 passes complete
8. GET /api/topics → verify new topic exists
9. GET /api/topics/:id/full → verify modules, lessons, concepts stored
10. Verify concept references and prerequisites created

**Scenario 2: Job Failure (AC8)**
1. Configure mock CLI runner to fail on pass 2 (both attempts)
2. POST /api/research → trigger orchestrator
3. GET /api/research/jobs/:id → verify status `failed`, error field contains meaningful message

**Scenario 3: Job Cancellation (AC9)**
1. POST /api/research → trigger orchestrator with a slow mock
2. POST /api/research/jobs/:id/cancel → verify 200
3. GET /api/research/jobs/:id → verify status `cancelled`

**Scenario 4: Progress Tracking (AC6, AC7)**
1. Configure mock CLI runner with delays or callbacks to allow progress checks
2. Verify progress JSON updated after each pass: pass number, modules planned/completed, concepts found

### Success Criteria
- All 10 acceptance criteria verified by at least one test scenario
- Tests pass with mocked CLI (no real Claude Code sessions)
- Tests run in < 30 seconds

## Verification

- 4 E2E tests pass: happy path (AC1-AC7, AC10), job failure (AC8), cancellation (AC9), progress tracking (AC6-AC7)
- All 10 acceptance criteria verified by at least one test scenario
- Happy path: POST creates job → 4-pass pipeline → published → topic/modules/lessons/concepts browsable via API
- Failure: pass fails after retry → job marked failed with error message
- Cancellation: cancel mid-pass → job marked cancelled
- Progress: 4/4 passes, pass descriptions populated
- Tests run in < 100ms (well within 30s requirement)
- `make check` passes

## Files Modified

- `api/internal/research/e2e_test.go` — Created: 4 E2E integration tests covering all PBI 6 acceptance criteria with mock CLIRunner, real DB, real handlers, HTTP test server
