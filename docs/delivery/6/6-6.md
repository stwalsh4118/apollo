# [6-6] Curriculum Ingester

[Back to task list](./tasks.md)

## Description

Implement the service that takes validated curriculum JSON output from a research session, parses it into domain objects, and stores the complete curriculum in SQLite using the existing write repository. This covers topics, modules, lessons, concepts, concept references, prerequisites, and expansion queue entries.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:52:24 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:55:20 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 08:29:09 | Status Change | Review | Done | All tasks verified, preparing PR | AI_Agent |

## Requirements

1. **CurriculumIngester** (`api/internal/research/ingest.go`):
   - `Ingest(ctx context.Context, jobID string, rawJSON json.RawMessage) error`
   - Steps:
     1. Validate `rawJSON` against curriculum schema using `schema.Validate()`
     2. Unmarshal into intermediate curriculum struct matching the JSON schema structure
     3. Map to existing `models.*Input` types for storage
     4. Store in order respecting foreign keys:
        - Topic (via `WriteRepository.CreateTopic`)
        - Modules (via `WriteRepository.CreateModule`) — ordered by `sort_order`
        - Lessons (via `WriteRepository.CreateLesson`) — ordered by `sort_order`
        - Concepts (via `WriteRepository.CreateConcept`) — those defined in this topic
        - Concept references (via `WriteRepository.CreateConceptReference`) — linking concepts to lessons
        - Prerequisites (via `WriteRepository.CreatePrerequisite`) — from the prerequisite list
     5. Create expansion queue entries for `helpful` and `deep_background` prerequisites
     6. Update search index entries for the new content

2. **Intermediate curriculum types** (`api/internal/research/curriculum.go`):
   - Struct hierarchy matching the JSON schema: `CurriculumOutput` → `ModuleOutput` → `LessonOutput` → sections
   - `ConceptOutput`, `PrerequisiteOutput` with priority classification
   - JSON tags matching the schema field names

3. **Expansion queue entries**:
   - For prerequisites classified as `helpful` or `deep_background`, insert into `expansion_queue` table
   - Status `available`, linked to the requesting topic

4. **Transaction safety**:
   - Entire ingestion should run in a single database transaction
   - If any step fails, roll back everything
   - This may require adding a transaction-aware method to WriteRepository or using `db.BeginTx` directly

5. **Error handling**:
   - Schema validation failure → return descriptive error
   - Duplicate topic (already exists) → return specific error for orchestrator to handle
   - FK violations → return descriptive error

## Implementation Plan

1. Create `api/internal/research/curriculum.go` with intermediate types matching JSON schema.
2. Create `api/internal/research/ingest.go` with `CurriculumIngester` struct.
3. Inject `*sql.DB` and `WriteRepository` (or use `*sql.DB` directly for transaction control).
4. Implement `Ingest()` with schema validation, parsing, and ordered storage.
5. Handle expansion queue inserts for non-essential prerequisites.
6. Create `api/internal/research/ingest_test.go`.

## Test Plan

- **Valid curriculum**: Seed a valid curriculum JSON matching the schema; verify topic, modules, lessons, concepts, prerequisites all stored correctly in DB.
- **Schema validation failure**: Verify invalid JSON rejected before any DB writes.
- **Transaction rollback**: Verify that if a mid-ingestion step fails (e.g., duplicate concept), all previous inserts are rolled back.
- **Expansion queue**: Verify `helpful` and `deep_background` prerequisites create expansion queue entries with status `available`.
- **Concept references**: Verify concept-lesson references correctly created.
- **Ordering**: Verify modules and lessons stored with correct sort_order.

## Verification

- 5 tests pass: valid curriculum, invalid JSON (schema validation), transaction rollback on duplicate, IngestWithResult counts, sort order verification
- Full curriculum stored: topic, module, 2 lessons, 2 concepts with flashcards, concept references, expansion queue entries
- Prerequisites skip non-existent target topics (FK constraint respected), expansion queue stores all helpful/deep_background
- Transaction rollback verified on duplicate ingest
- `make check` passes

## Files Modified

- `api/internal/research/curriculum.go` — Created: intermediate types matching JSON schema (CurriculumOutput, ModuleOutput, LessonOutput, ConceptTaughtOut, etc.)
- `api/internal/research/ingest.go` — Created: CurriculumIngester with Ingest() and IngestWithResult(), transactional storage
- `api/internal/research/ingest_test.go` — Created: 5 integration tests with realistic sample curriculum JSON
