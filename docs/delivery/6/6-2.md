# [6-2] Research Job Repository

[Back to task list](./tasks.md)

## Description

Implement the data access layer for the `research_jobs` table. Provides CRUD operations for creating jobs, querying status, updating progress, and cancelling jobs. Follows the existing repository pattern established in PBI 2.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:41:20 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:44:46 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 08:29:09 | Status Change | Review | Done | All tasks verified, preparing PR | AI_Agent |

## Requirements

1. **ResearchJobRepository interface** (`api/internal/repository/research.go`):
   - `CreateJob(ctx, input CreateResearchJobInput) (*ResearchJob, error)` — insert new job with status `queued`, generate UUID, set timestamps
   - `GetJobByID(ctx, id string) (*ResearchJob, error)` — fetch single job by ID, return `ErrNotFound` if missing
   - `ListJobs(ctx, params PaginationParams) (*PaginatedResponse[ResearchJobSummary], error)` — list jobs ordered by `started_at` DESC, with pagination
   - `UpdateJobStatus(ctx, id string, status ResearchJobStatus, errorMsg string) error` — update status and optionally set error message; set `started_at` on first transition from queued, `completed_at` on terminal states
   - `UpdateJobProgress(ctx, id string, progress ResearchProgress) error` — update the progress JSON field
   - `UpdateJobCurrentTopic(ctx, id string, topic string) error` — update current_topic field

2. **Follow existing patterns**:
   - Use `*sql.DB` injected via constructor
   - Use sentinel errors from `repository/errors.go`
   - Use `models.PaginationParams` for pagination

3. **SQL considerations**:
   - `progress` column stores JSON — marshal `ResearchProgress` to JSON before storing
   - Use parameterized queries (no SQL injection)
   - Handle `NULL` columns (`started_at`, `completed_at`, `error`, `progress`) with sql.NullString or pointer types

## Implementation Plan

1. Create `api/internal/repository/research.go` with the `ResearchJobRepository` struct and constructor.
2. Implement each method following existing repository patterns (see `write.go`, `progress.go`).
3. Create `api/internal/repository/research_test.go` with integration tests using the test helper pattern.

## Test Plan

- **CreateJob**: Verify job created with `queued` status, valid UUID, correct topic.
- **GetJobByID**: Verify retrieval of existing job, `ErrNotFound` for missing ID.
- **ListJobs**: Verify pagination, ordering (most recent first), empty list handling.
- **UpdateJobStatus**: Verify status transitions, `started_at` set on first non-queued status, `completed_at` set on terminal states (`published`, `failed`, `cancelled`).
- **UpdateJobProgress**: Verify JSON field updated correctly, retrievable via GetJobByID.
- **UpdateJobCurrentTopic**: Verify current_topic field updated.

## Verification

- All 13 repository tests pass (create, get, get not found, list, list pagination, update status, update status failed, update status not found, update status started_at not overwritten, update progress, update progress not found, update current topic, update current topic not found)
- `make check` passes (fmt, vet, tests)
- Parameterized queries throughout, no SQL injection
- NULL handling via COALESCE for all nullable columns

## Files Modified

- `api/internal/repository/research.go` — Created: ResearchJobRepository interface, SQLiteResearchJobRepository implementation with all CRUD operations
- `api/internal/repository/research_test.go` — Created: 13 integration tests covering all operations and error cases
