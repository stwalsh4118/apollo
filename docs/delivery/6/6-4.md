# [6-4] Knowledge Pool Summary Builder

[Back to task list](./tasks.md)

## Description

Implement a service that queries existing topics and concepts from the database and produces a `knowledge_pool_summary.json` file matching the schema at `schemas/knowledge_pool_summary.json`. This file is written to the research session's working directory before spawning the CLI, providing context about what already exists in the knowledge pool.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. **PoolSummaryBuilder** (`api/internal/research/pool.go`):
   - `Build(ctx context.Context) ([]byte, error)` — queries DB, returns JSON bytes
   - `WriteToDir(ctx context.Context, dir string) error` — builds and writes `knowledge_pool_summary.json` to the specified directory
   - Queries existing topics (ID, title, module slugs) via repository
   - Queries existing concept slugs via repository
   - Produces JSON matching the `knowledge_pool_summary.json` schema:
     ```json
     {
       "existing_topics": [{ "topic_id": "...", "title": "...", "modules": ["..."] }],
       "existing_concepts": ["concept-slug-1", "concept-slug-2"]
     }
     ```
   - Validates output using `schema.ValidatePoolSummary()` before returning

2. **Repository queries needed**:
   - List all topics with their module IDs/slugs — can use existing `TopicRepository.ListTopics()` plus a new query for module IDs per topic, OR a single joined query
   - List all concept IDs — can use existing `ConceptRepository.ListConcepts()` or a simpler dedicated query

3. **Handle empty pool**: If no topics/concepts exist, produce valid JSON with empty arrays.

## Implementation Plan

1. Create `api/internal/research/` package directory.
2. Create `api/internal/research/pool.go` with `PoolSummaryBuilder` struct.
3. Inject `*sql.DB` dependency (or specific repository interfaces).
4. Implement `Build()` with DB queries and JSON marshaling.
5. Implement `WriteToDir()` using `Build()` + `os.WriteFile`.
6. Validate output with `schema.ValidatePoolSummary()`.
7. Create `api/internal/research/pool_test.go`.

## Test Plan

- **Empty pool**: Verify valid JSON with empty arrays when DB has no topics/concepts.
- **Populated pool**: Seed DB with topics, modules, concepts; verify JSON output matches expected structure.
- **Schema validation**: Verify output passes `schema.ValidatePoolSummary()`.
- **WriteToDir**: Verify file written to correct path with correct contents.

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
