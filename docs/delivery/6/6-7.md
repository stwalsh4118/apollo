# [6-7] Research Pipeline Orchestrator

[Back to task list](./tasks.md)

## Description

Implement the top-level orchestrator service that ties together all research components: job lifecycle management, context preparation, multi-turn 4-pass pipeline execution, progress tracking, error handling with retry, and cancellation support. This is the core engine that takes a queued research job and drives it through to a published curriculum.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:15:29 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. **Orchestrator** (`api/internal/research/orchestrator.go`):
   - `Start(ctx context.Context)` — starts a background goroutine that processes queued jobs
   - `RunJob(ctx context.Context, jobID string) error` — execute the full pipeline for a single job
   - `Cancel(jobID string)` — cancel a running job via context cancellation

2. **Job lifecycle** (per PRD section 9.1):
   - `queued` → `researching` → `resolving` → `published` (happy path)
   - `queued`/`researching` → `failed` (on unrecoverable error)
   - `queued`/`researching` → `cancelled` (on cancel request)

3. **Pipeline execution** (per PRD section 6.4):
   - **Context preparation**: Create working directory under `RESEARCH_WORK_DIR`, write `knowledge_pool_summary.json` via PoolSummaryBuilder
   - **Prepare topic brief**: Construct the initial prompt with topic name, depth, size limit, and boundary guidance
   - **Pass 1 (Survey)**: Run initial CLI pass with topic brief. Extract session_id. Update progress: pass 1/4.
   - **Pass 2 (Deep Dive)**: Resume session with deep-dive instructions. Update progress: pass 2/4.
   - **Pass 3 (Exercises)**: Resume session with exercise generation instructions. Update progress: pass 3/4.
   - **Pass 4 (Validation + Structured Output)**: Resume session with `--json-schema`. Extract `structured_output`. Update progress: pass 4/4.
   - **Ingestion**: Transition to `resolving`, validate and ingest curriculum via CurriculumIngester
   - **Completion**: Transition to `published`

4. **Progress tracking**:
   - Update `ResearchProgress` in DB after each pass completes
   - Include: current pass, total passes, modules planned/completed (after pass 1+), concepts found (after pass 2+)

5. **Error handling**:
   - If a pass fails, retry up to 1 time with the same session (via `--resume`)
   - If retry fails, mark job as `failed` with error details
   - If schema validation fails on final output, mark as `failed`

6. **Cancellation**:
   - Maintain a map of `jobID → cancel func`
   - When `Cancel()` called, invoke the cancel func to kill the CLI process
   - Update job status to `cancelled`

7. **Concurrency**:
   - For PBI 6, single job at a time (PBI 8 adds parallel execution)
   - Use a channel or simple loop to pick up queued jobs

8. **Dependencies**:
   - `CLIRunner` interface (Task 6-5) for CLI execution
   - `PoolSummaryBuilder` (Task 6-4) for context preparation
   - `CurriculumIngester` (Task 6-6) for output storage
   - `ResearchJobRepository` (Task 6-2) for job state management

9. **Server integration**:
   - The orchestrator is created in `main.go` / server setup with all dependencies injected
   - `Start()` called as a background goroutine during server startup
   - `Cancel()` exposed to the research handler for the cancel endpoint

## Implementation Plan

1. Create `api/internal/research/orchestrator.go` with `Orchestrator` struct.
2. Implement dependency injection: `CLIRunner`, `PoolSummaryBuilder`, `CurriculumIngester`, `ResearchJobRepository`, logger, config.
3. Implement `RunJob()` with the full 4-pass pipeline.
4. Implement progress updates between passes.
5. Implement error handling with retry logic.
6. Implement cancellation map and `Cancel()`.
7. Implement `Start()` background loop.
8. Wire orchestrator into server setup — update `main.go` and `server.go`.
9. Create `api/internal/research/orchestrator_test.go`.

## Test Plan

### Objectives
Verify the orchestrator correctly drives the research pipeline through all states, handles errors, and supports cancellation.

### Mocking Strategy
- Mock `CLIRunner` to return canned `CLIResponse` objects (no real CLI calls)
- Mock `CurriculumIngester` to verify it's called with correct data
- Use real `ResearchJobRepository` with test DB
- Mock `PoolSummaryBuilder` to write a canned summary file

### Key Scenarios
1. **Happy path**: Job transitions `queued → researching → resolving → published`. All 4 passes executed. Progress updated after each pass. Curriculum ingested.
2. **Pass failure + retry**: Mock pass 2 to fail once, succeed on retry. Verify job still completes.
3. **Unrecoverable failure**: Mock pass to fail twice. Verify job marked `failed` with error message.
4. **Cancellation**: Start a job, cancel mid-execution. Verify status becomes `cancelled`.
5. **Schema validation failure**: Mock final pass to return invalid structured output. Verify job marked `failed`.
6. **Progress tracking**: Verify progress JSON updated correctly after each pass (pass number, modules, concepts).

### Success Criteria
- All job state transitions match the defined lifecycle
- Progress field accurately reflects pipeline stage
- Failed jobs include meaningful error messages
- Cancelled jobs stop execution promptly

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
