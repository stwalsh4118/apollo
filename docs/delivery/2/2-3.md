# [2-3] Topic Repository & Handlers

[Back to task list](./tasks.md)

## Description

Implement the data access layer and HTTP handlers for topic endpoints. The repository package provides SQLite query methods; the handlers wire them to chi routes. Covers three endpoints: topic list, topic detail (with modules), and topic full tree (nested modules → lessons → concepts).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:15:55 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:45:07 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. Create `api/internal/repository/` package with a `TopicRepository` interface
2. Implement `SQLiteTopicRepository` with methods:
   - `ListTopics(ctx) ([]TopicSummary, error)` — all topics ordered by title, with module count and difficulty
   - `GetTopicByID(ctx, id) (*TopicDetail, error)` — topic with its modules (no lesson content)
   - `GetTopicFull(ctx, id) (*TopicFull, error)` — topic with nested modules → lessons → concepts
3. Register handlers on chi router:
   - `GET /api/topics` → list all topics
   - `GET /api/topics/{id}` → topic with modules
   - `GET /api/topics/{id}/full` → full nested tree
4. Handle 404 when topic ID not found
5. Parse JSON columns (tags, source_urls) into Go slices
6. Module count derived from query (COUNT or len after join)

## Implementation Plan

1. Create `api/internal/repository/topic.go` — interface + SQLite implementation
2. Query patterns:
   - List: `SELECT ... FROM topics ORDER BY title` with module count subquery
   - Detail: topic row + `SELECT ... FROM modules WHERE topic_id = ? ORDER BY sort_order`
   - Full: topic + modules + lessons per module + concepts per lesson (via concept_references)
3. Create `api/internal/handler/topic.go` — HTTP handlers using TopicRepository
4. Register routes in `server.go` under `/api/topics`

## Test Plan

### Repository Tests
- **ListTopics**: Seed 3 topics, verify all returned ordered by title with correct module counts
- **GetTopicByID**: Seed topic with 2 modules, verify detail includes modules in sort order
- **GetTopicByID not found**: Verify error/nil for nonexistent ID
- **GetTopicFull**: Seed topic → module → lesson → concept reference, verify full nested tree
- **JSON columns**: Verify tags and source_urls parse correctly from JSON TEXT columns

### Handler Tests
- **GET /api/topics**: Returns 200 with JSON array of topic summaries
- **GET /api/topics/{id}**: Returns 200 with topic detail including modules
- **GET /api/topics/{id}/full**: Returns 200 with full nested tree
- **GET /api/topics/{id} not found**: Returns 404 with error message

## Verification

- All repository tests pass: list (empty, ordered, module count, JSON tags), get by ID, not found, full nested tree
- All handler tests pass with mock repositories: list, error, get by ID, not found, full tree, full not found
- Explicit rows.Close() before nested queries to avoid deadlock with maxOpenConns=1
- errors.Is used for sentinel error comparison
- `make check` green in 382ms

## Files Modified

- `api/internal/repository/topic.go` — NEW: TopicRepository interface, SQLiteTopicRepository
- `api/internal/repository/testhelper_test.go` — NEW: shared test helpers (setupTestDB, seed functions)
- `api/internal/repository/topic_test.go` — NEW: repository integration tests
- `api/internal/handler/topic.go` — NEW: TopicHandler with RegisterRoutes
- `api/internal/handler/topic_test.go` — NEW: handler tests with mock repository
- `api/internal/server/server.go` — MODIFIED: wired topic handler and repository
