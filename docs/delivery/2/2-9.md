# [2-9] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI 2 Conditions of Satisfaction. Seeds a realistic curriculum dataset, starts the HTTP server, and exercises every endpoint to verify correct JSON responses, pagination, search, graph data, and write operations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 12:11:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 12:16:26 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 12:22:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create a comprehensive E2E test that verifies all 8 acceptance criteria from the PBI
2. Seed realistic curriculum data: 2+ topics, 3+ modules, 5+ lessons, 5+ concepts, concept references, prerequisites, relations
3. Start the full HTTP server (router + all handlers) against a test database
4. Test every endpoint with real HTTP requests

## Implementation Plan

1. Create `api/internal/server/e2e_test.go` (or `test/integration/api_test.go`)
2. Test setup: create temp database, run migrations, seed test data, start test server
3. Test cases mapped to acceptance criteria:

### AC1: All GET endpoints return correct JSON
- Hit every GET endpoint, verify 200 status and valid JSON

### AC2: Topic list ordered by title with difficulty and module count
- `GET /api/topics` — verify ordered, has difficulty badge, has module_count field

### AC3: Full topic tree returns nested modules → lessons → concepts
- `GET /api/topics/{id}/full` — verify nested structure at all levels

### AC4: Concept references endpoint returns all teaching/referencing lessons
- `GET /api/concepts/{id}/references` — verify all seeded references returned

### AC5: FTS5 search returns results with relevance ranking
- `GET /api/search?q=...` — verify results from topics, lessons, and concepts; verify rank ordering

### AC6: Graph endpoint returns nodes and edges
- `GET /api/graph` — verify topic nodes, concept nodes, prerequisite edges, reference edges, relation edges

### AC7: Write endpoints store data with FK integrity
- `POST /api/topics` + `POST /api/modules` + `POST /api/lessons` — create, then read back
- Test FK violation returns error

### AC8: Pagination works on list endpoints
- `GET /api/concepts?page=1&per_page=2` — verify pagination fields and correct item count
- `GET /api/search?q=...&page=1&per_page=2` — verify search pagination

## Test Plan

This IS the test plan — the task itself is the E2E CoS verification. All test cases above map directly to acceptance criteria. Tests must pass for PBI 2 to be considered complete.

### Success Criteria
- All 8 acceptance criteria verified with passing tests
- No test failures
- Test covers happy paths and key error cases (404, 400, FK violations)

## Verification

- All 10 E2E tests pass: `make check` green (server package 0.055s)
- Internal AI review: pass (0 critical, 1 high fixed, 4 medium fixed, 4 low)
- Post-fix re-verification: all tests pass after applying review fixes
- All 8 acceptance criteria verified with dedicated test functions
- Happy paths and error cases covered (404, 400, 409, 422)

## Files Modified

- `api/internal/server/e2e_test.go` — Created: E2E test suite with 10 test functions covering all 8 acceptance criteria
- `api/internal/server/server_test.go` — Pre-existing: provides `setupTestServer` helper used by E2E tests
