# [2-8] Knowledge Graph Endpoints

[Back to task list](./tasks.md)

## Description

Implement the knowledge graph endpoints that return node and edge data for visualization (used by PBI 12's D3.js concept map). The full graph returns all topics and concepts as nodes, with edges from prerequisites, concept references, and topic relations. The topic subgraph scopes to a single topic's concepts and their connections.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 12:07:01 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 12:10:34 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 12:22:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add to repository:
   - `GraphRepository` interface with:
     - `GetFullGraph(ctx) (*GraphData, error)` — all nodes and edges
     - `GetTopicGraph(ctx, topicID) (*GraphData, error)` — subgraph for one topic
2. Nodes: topics (type="topic") and concepts (type="concept") with id, label, and metadata
3. Edges from three sources:
   - `topic_prerequisites`: source=topic, target=prerequisite, type=priority (essential/helpful/deep_background)
   - `concept_references`: source=concept, target=lesson's topic, type="reference"
   - `topic_relations`: source=topic_a, target=topic_b, type=relation_type
4. Topic subgraph: topic node + its concepts + edges involving those nodes
5. Register handlers:
   - `GET /api/graph` → full graph
   - `GET /api/graph/topic/{id}` → topic subgraph
6. Handle 404 when topic ID not found (for subgraph)

## Implementation Plan

1. Create `api/internal/repository/graph.go` — GraphRepository interface + SQLite implementation
2. Full graph queries:
   - Nodes: `SELECT id, title, 'topic' as type FROM topics` UNION `SELECT id, name, 'concept' as type FROM concepts`
   - Edges: three separate queries for prerequisites, references, relations
3. Topic subgraph: filter nodes to topic + its concepts (`WHERE defined_in_topic = ?`), filter edges to those involving returned node IDs
4. Create `api/internal/handler/graph.go` — HTTP handlers
5. Register routes in `server.go`

## Test Plan

- **Full graph nodes**: Seed 2 topics + 3 concepts, verify all returned as nodes with correct types
- **Full graph edges**: Seed prerequisite + reference + relation, verify all edge types present
- **Topic subgraph**: Seed 2 topics each with concepts, request subgraph for one, verify only relevant nodes/edges returned
- **Topic subgraph not found**: Request nonexistent topic, returns 404
- **Empty graph**: No data seeded, returns empty nodes and edges arrays

## Verification

- All tests pass: `make check` green (handler 0.004s, repository 0.084s)
- Internal AI review: pass (0 critical, 0 high, 1 medium semantic clarification addressed with comment, 5 low)
- SQLite connection safety verified: all queries sequential with rows consumed before next query

## Files Modified

- `api/internal/repository/graph.go` — Created: GraphRepository interface + SQLiteGraphRepository with full/topic subgraph queries
- `api/internal/handler/graph.go` — Created: GraphHandler with GET /api/graph and GET /api/graph/topic/{id}
- `api/internal/server/server.go` — Modified: wired graph handler
- `api/internal/repository/graph_test.go` — Created: full graph nodes/edges, topic subgraph, not found, empty graph tests
- `api/internal/handler/graph_test.go` — Created: mock-based handler tests for full graph, topic graph, not found, error
