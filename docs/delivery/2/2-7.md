# [2-7] Search Endpoint

[Back to task list](./tasks.md)

## Description

Implement the full-text search endpoint using SQLite FTS5. The `search_index` virtual table already exists in the schema (PBI 1). This task builds the repository query and HTTP handler for `GET /api/search?q=...` returning ranked results across topics, lessons, and concepts.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Add to repository:
   - `SearchRepository` interface with `Search(ctx, query, params) (*PaginatedResponse[SearchResult], error)`
2. Use FTS5 `MATCH` syntax against the `search_index` table
3. Results include: `entity_type`, `entity_id`, `title`, `snippet` (using FTS5 `snippet()` function)
4. Results ordered by FTS5 relevance ranking (`rank` column)
5. Pagination support (page, per_page query params)
6. Handle empty query: return 400 error
7. Handle no results: return empty array (not 404)
8. Register handler: `GET /api/search?q=...`

## Implementation Plan

1. Create `api/internal/repository/search.go` — SearchRepository interface + SQLite implementation
2. Search query:
   ```sql
   SELECT entity_type, entity_id, title, snippet(search_index, 3, '<mark>', '</mark>', '...', 30)
   FROM search_index
   WHERE search_index MATCH ?
   ORDER BY rank
   LIMIT ? OFFSET ?
   ```
3. Count query for pagination total: `SELECT COUNT(*) FROM search_index WHERE search_index MATCH ?`
4. Create `api/internal/handler/search.go` — HTTP handler
5. Register route in `server.go`

## Test Plan

- **Search with results**: Seed search_index with test data, search for known term, verify results returned with correct fields
- **Search relevance**: Seed entries with varying term frequency, verify higher-relevance results first
- **Search pagination**: Seed 10+ entries, verify page/per_page works correctly
- **Search snippet**: Verify snippet contains highlighted match markers
- **Empty query**: `GET /api/search` (no q param) returns 400
- **No matches**: Search for nonsense term returns empty items array with total=0

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
