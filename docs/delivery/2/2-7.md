# [2-7] Search Endpoint

[Back to task list](./tasks.md)

## Description

Implement the full-text search endpoint using SQLite FTS5. The `search_index` virtual table already exists in the schema (PBI 1). This task builds the repository query and HTTP handler for `GET /api/search?q=...` returning ranked results across topics, lessons, and concepts.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 12:03:06 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 12:06:34 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 12:22:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add to repository:
   - `SearchRepository` interface with `Search(ctx, query, params) (*PaginatedResponse[SearchResult], error)`
2. Use FTS5 `MATCH` syntax against the `search_index` table
3. Results include: `entity_type`, `entity_id`, `title`, `snippet` (using FTS5 `snippet()` function)
4. Results ordered by FTS5 relevance ranking (`rank` column)
5. Pagination support (page, per_page query params)
6. Handle empty query: return 400 error
7. Handle no results: return empty array (not 404)
8. Register handler: `GET /api/search?q=...`

## Implementation Plan

1. Create `api/internal/repository/search.go` — SearchRepository interface + SQLite implementation
2. Search query:
   ```sql
   SELECT entity_type, entity_id, title, snippet(search_index, 3, '<mark>', '</mark>', '...', 30)
   FROM search_index
   WHERE search_index MATCH ?
   ORDER BY rank
   LIMIT ? OFFSET ?
   ```
3. Count query for pagination total: `SELECT COUNT(*) FROM search_index WHERE search_index MATCH ?`
4. Create `api/internal/handler/search.go` — HTTP handler
5. Register route in `server.go`

## Test Plan

- **Search with results**: Seed search_index with test data, search for known term, verify results returned with correct fields
- **Search relevance**: Seed entries with varying term frequency, verify higher-relevance results first
- **Search pagination**: Seed 10+ entries, verify page/per_page works correctly
- **Search snippet**: Verify snippet contains highlighted match markers
- **Empty query**: `GET /api/search` (no q param) returns 400
- **No matches**: Search for nonsense term returns empty items array with total=0

## Verification

- All tests pass: `make check` green (handler 0.002s, repository 0.085s)
- Internal AI review: pass (0 critical, 0 high, 4 medium addressed, 4 low)
- Fixed: ErrInvalidQuery uses errors.New (idiomatic); classifySearchError also catches "unterminated string"
- Fixed: Added handler test for ErrInvalidQuery → 400 path
- Fixed: Added repository test for invalid FTS5 syntax (unterminated quote)
- Added snippet column index comment for clarity

## Files Modified

- `api/internal/repository/search.go` — Created: SearchRepository interface + SQLiteFTS5 implementation with ErrInvalidQuery
- `api/internal/handler/search.go` — Created: SearchHandler with GET /api/search?q=...
- `api/internal/server/server.go` — Modified: wired search handler
- `api/internal/repository/search_test.go` — Created: FTS5 search tests (results, pagination, no results, invalid syntax, snippet)
- `api/internal/handler/search_test.go` — Created: mock-based handler tests (happy path, empty query, invalid query, error)
