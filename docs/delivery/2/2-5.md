# [2-5] Concept Repository & Handlers

[Back to task list](./tasks.md)

## Description

Implement the data access layer and HTTP handlers for concept endpoints. Includes paginated concept listing with optional topic filtering, concept detail with references, and a dedicated references endpoint returning all lessons that teach or reference a concept.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:50:43 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:55:22 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 12:22:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add to repository package:
   - `ConceptRepository` interface with:
     - `ListConcepts(ctx, params) (*PaginatedResponse[ConceptSummary], error)` — paginated, filterable by topic_id
     - `GetConceptByID(ctx, id) (*ConceptDetail, error)` — concept with inline references
     - `GetConceptReferences(ctx, id) ([]ConceptReference, error)` — all lessons teaching/referencing this concept
2. Pagination: accept `page` and `per_page` query params (defaults: page=1, per_page=20)
3. Topic filtering: optional `topic` query param filters concepts by `defined_in_topic`
4. Concept detail includes: all concept fields + list of references (lesson_id, lesson title, context)
5. References endpoint: join `concept_references` with `lessons` to return lesson details and context
6. Register handlers:
   - `GET /api/concepts` → paginated concept list
   - `GET /api/concepts/{id}` → concept detail with references
   - `GET /api/concepts/{id}/references` → lesson references for a concept
7. Handle 404 when concept ID not found
8. Parse JSON columns (aliases) into Go slices

## Implementation Plan

1. Create `api/internal/repository/concept.go` — ConceptRepository interface + SQLite implementation
2. List query: `SELECT ... FROM concepts` with optional `WHERE defined_in_topic = ?`, `LIMIT/OFFSET` for pagination, `COUNT(*)` for total
3. Detail query: concept row + join to concept_references + lessons for reference details
4. References query: `SELECT cr.*, l.title, l.module_id FROM concept_references cr JOIN lessons l ON cr.lesson_id = l.id WHERE cr.concept_id = ?`
5. Create `api/internal/handler/concept.go` — HTTP handlers
6. Register routes in `server.go`

## Test Plan

### Repository Tests
- **ListConcepts**: Seed 5 concepts, verify pagination returns correct page with total count
- **ListConcepts with topic filter**: Seed concepts across 2 topics, verify filter returns only matching topic
- **GetConceptByID**: Seed concept with 2 references, verify detail includes reference list
- **GetConceptByID not found**: Returns error/nil
- **GetConceptReferences**: Seed concept referenced in 3 lessons, verify all returned with lesson titles

### Handler Tests
- **GET /api/concepts**: Returns 200 with paginated response (items, total, page, per_page)
- **GET /api/concepts?topic=X**: Returns filtered results
- **GET /api/concepts?page=2&per_page=2**: Returns correct page
- **GET /api/concepts/{id}**: Returns 200 with concept detail
- **GET /api/concepts/{id}/references**: Returns 200 with reference list
- **GET /api/concepts/{id} not found**: Returns 404

## Verification

- All tests pass: `make check` green (handler 0.003s, repository 0.048s)
- Internal AI review: pass (0 critical, 0 high, 0 medium after fix, 5 low — all deferrable)
- SQLite deadlock safety verified: QueryRowContext releases connection before nested queryReferences
- Fixed medium finding: renamed misnamed test, added proper empty-refs test case

## Files Modified

- `api/internal/repository/concept.go` — Created: ConceptRepository interface + SQLiteConceptRepository
- `api/internal/handler/concept.go` — Created: ConceptHandler with GET /api/concepts, /api/concepts/{id}, /api/concepts/{id}/references
- `api/internal/server/server.go` — Modified: wired concept handler
- `api/internal/repository/concept_test.go` — Created: ListConcepts, pagination, topic filter, GetConceptByID, GetConceptReferences, not-found, and empty tests
- `api/internal/handler/concept_test.go` — Created: mock-based handler tests for all endpoints
