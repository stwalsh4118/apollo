# [2-4] Module & Lesson Repository & Handlers

[Back to task list](./tasks.md)

## Description

Implement the data access layer and HTTP handlers for module and lesson detail endpoints. Module detail returns the module with its lessons (summaries). Lesson detail returns a single lesson with all content JSON (content sections, examples, exercises, review questions).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:45:07 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:51:08 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 11:50:43 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. Add to repository package:
   - `ModuleRepository` interface with `GetModuleByID(ctx, id) (*ModuleDetail, error)`
   - `LessonRepository` interface with `GetLessonByID(ctx, id) (*LessonDetail, error)`
2. Module detail includes: module fields + list of lesson summaries (id, title, sort_order, estimated_minutes)
3. Lesson detail includes: all lesson fields + parsed content JSON, examples, exercises, review_questions
4. Register handlers:
   - `GET /api/modules/{id}` → module with its lessons
   - `GET /api/lessons/{id}` → lesson with full content
5. Handle 404 when module/lesson ID not found
6. Parse JSON columns (learning_objectives, assessment, content, examples, exercises, review_questions) into appropriate Go types

## Implementation Plan

1. Create `api/internal/repository/module.go` — ModuleRepository interface + SQLite implementation
2. Create `api/internal/repository/lesson.go` — LessonRepository interface + SQLite implementation
3. Module query: module row + `SELECT id, title, sort_order, estimated_minutes FROM lessons WHERE module_id = ? ORDER BY sort_order`
4. Lesson query: single row with all columns, parse JSON TEXT fields
5. Create `api/internal/handler/module.go` and `api/internal/handler/lesson.go`
6. Register routes in `server.go`

## Test Plan

### Repository Tests
- **GetModuleByID**: Seed module with 3 lessons, verify lessons returned in sort order
- **GetModuleByID not found**: Returns error/nil for nonexistent ID
- **GetLessonByID**: Seed lesson with JSON content, verify all JSON fields parsed correctly
- **GetLessonByID not found**: Returns error/nil for nonexistent ID

### Handler Tests
- **GET /api/modules/{id}**: Returns 200 with module detail including lesson list
- **GET /api/modules/{id} not found**: Returns 404
- **GET /api/lessons/{id}**: Returns 200 with full lesson content
- **GET /api/lessons/{id} not found**: Returns 404

## Verification

- `make check` passes: fmt, vet, all tests green
- Internal AI review: pass (0 critical, 0 high, 0 medium, 8 low)

## Files Modified

- `api/internal/repository/module.go` — Created: ModuleRepository interface + SQLite implementation
- `api/internal/repository/lesson.go` — Created: LessonRepository interface + SQLite implementation
- `api/internal/handler/module.go` — Created: ModuleHandler with GET /api/modules/{id}
- `api/internal/handler/lesson.go` — Created: LessonHandler with GET /api/lessons/{id}
- `api/internal/server/server.go` — Modified: wired module and lesson handlers
- `api/internal/repository/module_test.go` — Created: repository tests
- `api/internal/repository/lesson_test.go` — Created: repository tests
- `api/internal/handler/module_test.go` — Created: mock-based handler tests
- `api/internal/handler/lesson_test.go` — Created: mock-based handler tests
