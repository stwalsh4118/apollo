# [2-1] HTTP Server & Router Foundation

[Back to task list](./tasks.md)

## Description

Set up the HTTP server infrastructure for the Apollo API. Add the `chi` router with standard middleware (request logging via zerolog, JSON content-type, panic recovery). Wire the HTTP server into `main.go` so it listens on the configured `SERVER_PORT`. Add a `GET /api/health` endpoint that returns database health status. Implement graceful shutdown on SIGINT/SIGTERM.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:04:22 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:10:47 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 12:22:07 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add `github.com/go-chi/chi/v5` as a dependency
2. Create `api/internal/server/` package with router setup
3. Register middleware: zerolog request logger, `application/json` content-type header, panic recovery
4. Create `GET /api/health` endpoint returning `{"status": "ok"}` (or error if DB unhealthy)
5. Wire HTTP server startup into `cmd/apollo/main.go` using `cfg.ServerPort`
6. Implement graceful shutdown with `os.Signal` handling (SIGINT, SIGTERM)
7. Log server start/stop events via zerolog

## Implementation Plan

1. `go get github.com/go-chi/chi/v5` to add router dependency
2. Create `api/internal/server/server.go`:
   - `New(db *database.Handle, logger zerolog.Logger) *Server` constructor
   - `Router() chi.Router` method that builds and returns the configured router
   - Middleware chain: recovery → request logging → content-type
3. Create `api/internal/server/health.go`:
   - `handleHealth` handler calling `database.HealthCheck`
4. Update `cmd/apollo/main.go`:
   - Create server instance after database init
   - Start `http.Server` with configured port
   - Signal handling with `os/signal` for graceful shutdown
   - Context-based shutdown with timeout

**External Packages**: This task requires research and a guide document for: `chi`

## Test Plan

- **Server starts**: Test that `New()` returns a valid server with a non-nil router
- **Health endpoint**: HTTP test against `GET /api/health` returns 200 with `{"status":"ok"}`
- **Content-Type**: Verify responses include `Content-Type: application/json`
- **Recovery middleware**: Verify panicking handler returns 500 instead of crashing

## Verification

- All tests pass (`make check` green)
- Health endpoint returns `{"status":"ok"}` on 200 and `{"status":"error"}` on 503
- Content-Type header set to `application/json`
- Panic recovery middleware verified with test that mounts panicking handler
- Graceful shutdown with SIGINT/SIGTERM via `signal.NotifyContext`
- HTTP server timeouts configured (ReadHeaderTimeout, IdleTimeout)
- Request duration logged via zerolog

## Files Modified

- `api/cmd/apollo/main.go` — wired HTTP server with graceful shutdown
- `api/internal/server/server.go` — NEW: chi router, middleware, zerolog request logger
- `api/internal/server/health.go` — NEW: health check endpoint
- `api/internal/server/server_test.go` — NEW: server and health endpoint tests
- `api/go.mod` / `api/go.sum` — added `github.com/go-chi/chi/v5 v5.2.5`
- `docs/delivery/2/2-1-chi-guide.md` — NEW: chi router API guide
