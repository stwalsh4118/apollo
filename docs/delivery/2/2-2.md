# [2-2] Response Models & JSON Helpers

[Back to task list](./tasks.md)

## Description

Define all Go structs for API response types and shared JSON helper functions. These models represent the shapes returned by all PBI-2 endpoints. Also includes pagination types and standard JSON response/error helpers used across all handlers.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:10:47 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 11:15:55 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. Create `api/internal/models/` package with all response structs
2. Topic models: `TopicSummary` (list view), `TopicDetail` (with modules, no lesson content), `TopicFull` (full nested tree)
3. Module models: `ModuleSummary` (in topic views), `ModuleDetail` (with lessons)
4. Lesson models: `LessonSummary` (in module views), `LessonDetail` (with full content JSON)
5. Concept models: `ConceptSummary` (list view), `ConceptDetail` (with references), `ConceptReference`
6. Search models: `SearchResult` with entity_type, entity_id, title, snippet
7. Graph models: `GraphNode`, `GraphEdge`, `GraphData`
8. Pagination: `PaginationParams` (parsed from query), `PaginatedResponse[T]` (generic wrapper with items, total, page, per_page)
9. JSON helpers: `WriteJSON(w, status, data)`, `WriteError(w, status, message)` in a `respond` package or similar
10. All struct fields must have appropriate `json:"..."` tags matching PRD schema expectations

## Implementation Plan

1. Create `api/internal/models/topic.go` — topic response structs
2. Create `api/internal/models/module.go` — module response structs
3. Create `api/internal/models/lesson.go` — lesson response structs
4. Create `api/internal/models/concept.go` — concept response structs
5. Create `api/internal/models/search.go` — search result structs
6. Create `api/internal/models/graph.go` — graph visualization structs
7. Create `api/internal/models/pagination.go` — pagination types and query parsing
8. Create `api/internal/respond/respond.go` — JSON response helpers

## Test Plan

- **Compilation**: All model structs compile and produce expected JSON via `json.Marshal`
- **Pagination parsing**: `PaginationParams` correctly parses page/per_page from URL query with defaults
- **JSON helpers**: `WriteJSON` sets correct status code and content-type; `WriteError` produces `{"error":"message"}` shape

## Verification

- All model structs compile and produce correct JSON via `json.Marshal` (tested)
- Embedded base structs flatten correctly in JSON output (tested)
- PaginationParams parsing: defaults, custom, clamping, invalid input (tested)
- respond.JSON sets Content-Type: application/json and correct status (tested)
- respond.Error produces `{"error":"message"}` shape (tested)
- ParseJSONStringSlice handles nil, empty, null, valid, invalid (tested)

## Files Modified

- `api/internal/models/topic.go` — NEW: TopicSummary, topicBase (embedded), TopicDetail, TopicFull
- `api/internal/models/module.go` — NEW: ModuleSummary, moduleBase (embedded), ModuleDetail, ModuleFull
- `api/internal/models/lesson.go` — NEW: LessonSummary, lessonBase (embedded), LessonDetail, LessonFull
- `api/internal/models/concept.go` — NEW: ConceptSummary, ConceptDetail, ConceptReference
- `api/internal/models/search.go` — NEW: SearchResult
- `api/internal/models/graph.go` — NEW: GraphNode, GraphEdge, GraphData
- `api/internal/models/pagination.go` — NEW: PaginationParams, PaginatedResponse[T], ParsePagination
- `api/internal/models/json.go` — NEW: ParseJSONStringSlice, ParseJSONRaw helpers
- `api/internal/respond/respond.go` — NEW: JSON and Error response helpers
- `api/internal/models/pagination_test.go` — NEW: pagination tests
- `api/internal/models/topic_test.go` — NEW: JSON parsing and serialization tests
- `api/internal/respond/respond_test.go` — NEW: response helper tests
