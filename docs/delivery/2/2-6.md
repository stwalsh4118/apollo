# [2-6] Curriculum Write Endpoints

[Back to task list](./tasks.md)

## Description

Implement internal write endpoints used by the research pipeline (PBI 6) to store curriculum data. These are not user-facing — they're called programmatically to persist topics, modules, lessons, concepts, concept references, prerequisites, and relations generated by the research agent.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 10:50:32 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 11:55:47 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 12:02:37 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |

## Requirements

1. Add write methods to repository:
   - `CreateTopic(ctx, topic) error` / `UpdateTopic(ctx, id, topic) error`
   - `CreateModule(ctx, module) error`
   - `CreateLesson(ctx, lesson) error`
   - `CreateConcept(ctx, concept) error`
   - `CreateConceptReference(ctx, ref) error`
   - `CreatePrerequisite(ctx, prereq) error`
   - `CreateRelation(ctx, relation) error`
2. Request models: input structs for each create/update operation
3. Populate `search_index` FTS5 table when creating/updating topics, lessons, and concepts
4. Foreign key integrity: all referenced entities must exist (rely on SQLite FK constraints)
5. Register handlers:
   - `POST /api/topics` — create a topic
   - `PUT /api/topics/{id}` — update a topic
   - `POST /api/modules` — create a module
   - `POST /api/lessons` — create a lesson
   - `POST /api/concepts` — create a concept
   - `POST /api/concepts/{id}/references` — add a concept reference
   - `POST /api/prerequisites` — add a topic prerequisite
   - `POST /api/relations` — add a topic relation
6. Return created entity or 201 status on success
7. Return 400 for validation errors, 409 for duplicate keys, 422 for FK violations

## Implementation Plan

1. Create `api/internal/models/input.go` — request body structs (TopicInput, ModuleInput, LessonInput, ConceptInput, etc.)
2. Create `api/internal/repository/write.go` — WriteRepository interface + SQLite implementation
3. Each write method:
   - Validate required fields
   - INSERT/UPDATE with appropriate SQL
   - Insert corresponding `search_index` entry for searchable entities (topics, lessons, concepts)
4. Create `api/internal/handler/write.go` — HTTP handlers parsing JSON request bodies
5. Register routes in `server.go`

## Test Plan

### Repository Tests
- **CreateTopic**: Insert topic, verify retrievable via read repository
- **UpdateTopic**: Create then update, verify changes persisted
- **CreateModule**: Insert module with valid topic_id, verify stored
- **CreateLesson**: Insert lesson with JSON content, verify stored and JSON valid
- **CreateConcept**: Insert concept, verify stored
- **CreateConceptReference**: Insert reference, verify join works in read queries
- **CreatePrerequisite**: Insert prerequisite, verify stored
- **CreateRelation**: Insert relation, verify stored
- **FK violation**: Attempt to create module with nonexistent topic_id, verify error
- **Duplicate key**: Attempt to create topic with existing ID, verify error
- **Search index**: Create topic + lesson + concept, verify search_index entries created

### Handler Tests
- **POST /api/topics**: Returns 201 with created topic
- **POST with invalid JSON**: Returns 400
- **POST with missing required fields**: Returns 400 with descriptive error
- **POST with FK violation**: Returns 422

## Verification

- All tests pass: `make check` green (handler 0.003s, repository 0.072s)
- Internal AI review: pass after fixes (0 critical, 0 high, 0 medium after fixes, 6 low — all deferrable)
- Fixed medium findings: added ErrCheckViolation→400 mapping, request body size limit (2MB), search index DELETE error handling, concept reference handler test

## Files Modified

- `api/internal/models/input.go` — Created: TopicInput, ModuleInput, LessonInput, ConceptInput, ConceptReferenceInput, PrerequisiteInput, RelationInput
- `api/internal/repository/write.go` — Created: WriteRepository interface + SQLiteWriteRepository with all create/update methods
- `api/internal/repository/errors.go` — Created: sentinel errors (ErrNotFound, ErrDuplicate, ErrFKViolation, ErrCheckViolation)
- `api/internal/handler/write.go` — Created: WriteHandler with POST/PUT endpoints for all entities
- `api/internal/server/server.go` — Modified: wired write handler
- `api/internal/repository/write_test.go` — Created: repository tests for all write operations including FK and duplicate tests
- `api/internal/handler/write_test.go` — Created: mock-based handler tests for all endpoints
