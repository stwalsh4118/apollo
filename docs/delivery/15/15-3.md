# [15-3] Update Research System Prompt

[Back to task list](./tasks.md)

## Description

Rewrite the research pipeline system prompt (`research.md`) to instruct agents to produce a file-per-lesson directory tree instead of accumulating content in memory for a monolithic structured output. Each pass writes/reads individual files using the Write and Read tools.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:42:07 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. **Pass 1 (Survey)** instructions updated to:
   - Perform web research and topic analysis (unchanged)
   - Write `topic.json` containing: topic metadata, prerequisites, related topics, and a module plan (array of `{id, title, description, order}` stubs)
   - Create `modules/<NN>-<slug>/` directories for each planned module
   - Do NOT produce lesson content yet

2. **Pass 2 (Deep Dive)** instructions updated to:
   - Main agent performs web research (unchanged)
   - Sub-agents write directly to the file tree:
     - Each sub-agent writes 1-2 lesson JSON files to `modules/<slug>/<NN>-<lesson>.json`
     - Each sub-agent writes/updates `modules/<slug>/module.json` with learning objectives
   - No assembly step — files land directly in the tree
   - Sub-agent chunk rule (max 2 lessons) remains

3. **Pass 3 (Exercises)** instructions updated to:
   - Sub-agents read existing lesson files from `modules/<slug>/<lesson>.json`
   - Add `exercises` and `review_questions` fields, then write back
   - Each sub-agent also writes the module `assessment` into `module.json`
   - Parallelization by module (unchanged pattern)

4. **Pass 4 (Validation)** instructions updated to:
   - Agent reads the file tree to review content quality
   - Applies the self-review checklist (unchanged content checks)
   - Fixes issues by reading and rewriting individual files
   - Does NOT produce structured output — Go code handles assembly
   - No `--json-schema` flag is used

5. **Directory conventions** clearly documented in prompt:
   - Module dirs: `NN-<slug>` format (e.g., `01-introduction`)
   - Lesson files: `NN-<slug>.json` format (e.g., `01-what-is-go.json`)
   - File paths relative to work directory

6. **JSON format** for each file type clearly specified in the prompt with example structures so agents know exactly what to write.

7. **Preserve** all existing quality rules: concept handling, knowledge pool awareness, source URLs, sub-agent chunk limits, no nesting, research in main session only.

## Implementation Plan

1. Read current `api/internal/research/prompts/research.md` thoroughly
2. Draft updated Pass 1 instructions with `topic.json` output spec and directory creation
3. Draft updated Pass 2 instructions with per-file sub-agent writing pattern
4. Draft updated Pass 3 instructions with read-modify-write pattern for exercises
5. Draft updated Pass 4 instructions removing structured output, focusing on quality review
6. Add directory convention reference section to the prompt
7. Add JSON format examples for `topic.json`, `module.json`, and lesson files
8. Review that all existing quality rules and constraints are preserved

## Test Plan

- **Compilation**: Go embed still works (file exists at expected path)
- **Content review**: Verify prompt contains all required sections and conventions
- **No regression**: All existing quality rules (concept handling, sub-agent limits, knowledge pool checks) are still present
- **Format examples**: Each file type has a clear JSON example in the prompt

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
