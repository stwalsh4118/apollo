# [15-4] Orchestrator Integration

[Back to task list](./tasks.md)

## Description

Modify the research orchestrator to use the new file-per-lesson pipeline flow. Pass 4 no longer uses `--json-schema`; after all passes complete, the orchestrator calls the Go assembler to produce `CurriculumOutput` and feeds it to the existing ingester.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:42:07 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 09:01:53 | Status Change | Proposed | Agreed | Task approved | AI_Agent |
| 2026-02-20 09:01:53 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 09:13:57 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 11:22:23 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Pass 4 change**: Use `runPass()` instead of `runFinalPass()` for Pass 4:
   - Remove `--json-schema` flag from Pass 4 invocation
   - Pass 4 becomes a regular resume pass (same as passes 2-3)

2. **Assembly step**: After Pass 4 completes, call `AssembleFromDir(workDir)`:
   - Returns assembled `CurriculumOutput`
   - Marshal to JSON for ingestion

3. **Ingestion**: Feed assembled JSON to existing `CurriculumIngester.Ingest()`:
   - This path is unchanged — the ingester receives the same `json.RawMessage` as before

4. **Remove `runFinalPass`**: This method is no longer needed. All four passes use `runPass()`. Remove or refactor `runFinalPass()` from the orchestrator.

5. **CLI runner cleanup**: The `ResumePassOpts.JSONSchemaFile` field is no longer set for Pass 4. Verify that `RunResumePass` handles an empty `JSONSchemaFile` correctly (should already work — it conditionally appends the flag).

6. **Error handling**: If assembly fails (e.g., malformed files, missing directories), the job should transition to "failed" with a descriptive error message, same as any other pipeline failure.

7. **Progress tracking**: Progress updates remain unchanged — `CurrentPass` is still updated per pass. After assembly, update progress to reflect completion.

## Implementation Plan

1. In `orchestrator.go`, modify `RunJob()`:
   - Change Pass 4 from `runFinalPass()` to `runPass()`
   - After Pass 4, add `assembleFromDir()` call
   - Marshal assembled output to `json.RawMessage`
   - Pass to `ingest.Ingest()`
2. Remove `runFinalPass()` method (or simplify if partial reuse makes sense)
3. Remove `JSONSchemaFile` assignment in Pass 4 invocation
4. Add assembly error handling with job status transition to "failed"
5. Update unit tests for orchestrator pass flow
6. Update `docs/api-specs/research/research-api.md` if the pipeline flow description changes

## Test Plan

### Objectives
Verify the orchestrator correctly executes all 4 passes and assembles the output.

### Key Scenarios

| # | Scenario | Expected |
|---|----------|----------|
| 1 | Pass 4 invoked without --json-schema | RunResumePass called with empty JSONSchemaFile |
| 2 | Assembly succeeds after Pass 4 | Ingester receives valid JSON, job transitions to published |
| 3 | Assembly fails (malformed file tree) | Job transitions to failed with descriptive error |
| 4 | runFinalPass removed | No compilation errors, no references remain |

### Success Criteria
- All 4 passes execute via `runPass()`
- Assembly produces valid output fed to ingester
- Failed assembly results in proper error propagation

## Verification

- `cd api && make check` — all tests pass (fmt, vet, test)
- `TestOrchestratorHappyPath` — all 4 passes via `runPass()`, assembly, ingestion, published
- `TestOrchestratorAssemblyFailure` — missing fixture files → job fails with descriptive error
- `TestOrchestratorCancellation` — context cancellation during pass 2 → job status "cancelled"
- `TestE2EHappyPath` — full pipeline with file tree fixtures → published
- `TestE2EJobCancellation` — cancel via API → status "cancelled"
- No references to `runFinalPass` remain in orchestrator code
- `ResumePassOpts.JSONSchemaFile` verified to handle empty value correctly (conditionally appends flag)

### AI Review Notes
- Medium #1 (cancellation during ingestion): Fixed — added `jobCtx.Err()` check before `failJob` in ingestion error path
- Medium #2 (`JSONSchemaFile` dead field): Deferred — task requirement 5 says "verify handles empty correctly", not "remove". Field remains as CLI runner capability. Follow-up candidate.

## Files Modified

- `api/internal/research/orchestrator.go` — Pass 4 uses `runPass()`, added `AssembleFromDir` + marshal + ingest, removed `runFinalPass`, added context cancellation check in retry loop and ingestion error path
- `api/internal/research/orchestrator_test.go` — Added `writeFixtures` callback and `writeSampleFixtureTree` helper, replaced StructuredOutput-based tests with fixture-based tests, replaced schema validation failure test with assembly failure test, removed unused `setResponse` method
- `api/internal/research/e2e_test.go` — Added `writeFixtures` callback, removed `HasSchema` field and AC4 check, replaced StructuredOutput setups with fixture file writing
