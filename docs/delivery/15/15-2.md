# [15-2] Directory Tree Assembler

[Back to task list](./tasks.md)

## Description

Implement a Go assembler that reads the file-per-lesson directory tree produced by passes 1-4 and assembles it into a valid `CurriculumOutput` struct. This replaces the previous approach of extracting structured output from the CLI's `--json-schema` response.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:42:07 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-20 08:51:47 | Status Change | Proposed | Agreed | Task approved | AI_Agent |
| 2026-02-20 08:51:47 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-20 08:56:31 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 11:22:23 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **`AssembleFromDir(workDir string) (*CurriculumOutput, error)`** function that:
   - Reads `topic.json` from the work directory root, unmarshals into `TopicFile`
   - Discovers module directories under `modules/` sorted by numeric prefix (e.g., `01-intro`, `02-basics`)
   - For each module directory:
     - Reads `module.json`, unmarshals into `ModuleFile`
     - Discovers lesson files (`*.json` excluding `module.json`) sorted by numeric prefix
     - Reads each lesson file, unmarshals into `LessonOutput`
   - Assembles all parts into a single `CurriculumOutput` struct
   - Validates the assembled JSON against the curriculum schema using `schema.Validate()`
   - Returns the populated `CurriculumOutput` or a descriptive error

2. **Sorting**: Module directories and lesson files must be sorted by their numeric prefix (`01-`, `02-`, etc.) to ensure deterministic ordering regardless of filesystem order.

3. **Error handling**:
   - Missing `topic.json` → clear error
   - Empty `modules/` directory → clear error
   - Missing `module.json` in a module directory → clear error
   - Malformed JSON in any file → error with file path context
   - Schema validation failure → error with validation details

4. **No file writing** — this function only reads and assembles.

## Implementation Plan

1. Create `api/internal/research/assembler.go`
2. Implement directory walking with `os.ReadDir` + sorting by numeric prefix
3. Implement helper to extract numeric prefix from directory/file names (e.g., `01-intro` → `1`)
4. Read and unmarshal each file type into corresponding structs from 15-1
5. Map `TopicFile` + `ModuleFile`s + `LessonOutput`s → `CurriculumOutput`
6. Marshal to JSON and run `schema.Validate()`
7. Write unit tests with fixture directory trees

## Test Plan

### Objectives
Verify the assembler correctly reads a file tree and produces valid `CurriculumOutput`.

### Test Scope
- Unit tests with fixture directories created in `t.TempDir()`

### Key Scenarios

| # | Scenario | Expected |
|---|----------|----------|
| 1 | Valid complete tree (topic + 2 modules + 4 lessons) | Returns valid CurriculumOutput, no error |
| 2 | Missing topic.json | Returns descriptive error |
| 3 | Empty modules directory | Returns descriptive error |
| 4 | Missing module.json in module dir | Returns error naming the module dir |
| 5 | Malformed JSON in a lesson file | Returns error with file path |
| 6 | Modules sorted correctly regardless of filesystem order | Module order matches numeric prefix |
| 7 | Lessons sorted correctly within modules | Lesson order matches numeric prefix |

### Success Criteria
- All scenarios pass
- Assembled output passes `schema.Validate()` for the valid case

## Verification

- All 8 tests pass: valid tree assembly, missing topic.json, empty modules, missing module.json, malformed lesson JSON, module sort order, lesson sort order, numericPrefix
- `make check` passes (fmt, vet, tests)
- Internal AI review: pass (0 critical, 0 high, 0 medium, 5 low)
- Low findings addressed: replaced custom string helper with strings.Contains, added os.Rename error checks in tests

## Files Modified

- `api/internal/research/assembler.go` — NEW: AssembleFromDir, assembleModule, readSortedDirs, readSortedLessonFiles, numericPrefix
- `api/internal/research/assembler_test.go` — NEW: 7 assembler tests + numericPrefix test + writeFixtureFile/buildValidFixtureTree helpers
