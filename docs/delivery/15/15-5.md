# [15-5] E2E Conditions of Satisfaction Test

[Back to task list](./tasks.md)

## Description

End-to-end test verifying that the complete file-per-lesson research pipeline meets all PBI 15 acceptance criteria. This task validates the full flow: job creation → 4 passes with file output → Go assembly → schema validation → SQLite ingestion.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-20 08:42:07 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all PBI 15 acceptance criteria:

1. **AC1**: Pass 1 writes `topic.json` and creates module directories
2. **AC2**: Pass 2 sub-agents write individual lesson files (~100-200 lines each) to `modules/<slug>/`
3. **AC3**: Pass 3 sub-agents read lesson files, add exercises/review questions, write back
4. **AC4**: No individual file in the work directory exceeds ~300 lines
5. **AC5**: Go assembler reads the file tree and produces a valid `CurriculumOutput`
6. **AC6**: Assembled output passes curriculum schema validation
7. **AC7**: Existing ingestion stores the same data in SQLite (API responses unchanged)
8. **AC8**: Partial progress survives — if pass 3 fails, pass 2 lesson files are still on disk
9. **AC9**: System prompt updated with file-writing instructions and directory conventions

## Implementation Plan

### Integration Tests (Go)

1. **Assembler integration test**: Create a realistic fixture directory tree with topic.json, module dirs, module.json files, and lesson files. Run `AssembleFromDir()`, validate output against schema, verify all fields populated correctly.

2. **Partial progress test**: Create a directory tree representing a pass-2-complete state (topic.json + modules with lessons but no exercises). Verify files exist and are valid JSON. Then simulate pass 3 adding exercises to a subset. Verify the untouched files remain intact.

3. **File size constraint test**: Using the fixture tree, verify no individual file exceeds 300 lines.

4. **Ingestion round-trip test**: Assemble from fixture tree → ingest into test SQLite DB → query back via repository → verify data matches fixture content.

### Prompt Verification

5. **System prompt content check**: Read `research.md` and verify it contains:
   - File-writing instructions for each pass
   - Directory naming conventions (`NN-<slug>`)
   - JSON format examples for topic.json, module.json, lesson files
   - No references to `--json-schema` structured output in passes 1-3

### Orchestrator Flow Verification

6. **No runFinalPass references**: Verify `runFinalPass` is removed or unused
7. **Pass 4 has no JSONSchemaFile**: Verify the orchestrator does not set `JSONSchemaFile` for Pass 4

## Test Plan

### Objectives
Validate PBI 15 acceptance criteria end-to-end.

### Environment & Setup
- Test SQLite database (in-memory or temp file)
- Fixture directory tree with realistic curriculum data
- Access to schema validation

### Key Scenarios

| # | Scenario | Validates AC |
|---|----------|-------------|
| 1 | Full assembly from valid fixture tree | AC5, AC6 |
| 2 | Assembled output ingested into SQLite, queried back | AC7 |
| 3 | No fixture file exceeds 300 lines | AC4 |
| 4 | Partial tree (pass 2 complete, pass 3 incomplete) has valid lesson files on disk | AC8 |
| 5 | System prompt contains file-writing instructions | AC9 |
| 6 | Orchestrator uses runPass for all 4 passes | AC1-AC3 (structural) |
| 7 | Pass 4 does not use --json-schema | AC5 (assembler replaces structured output) |

### Success Criteria
- All scenarios pass
- All 9 acceptance criteria verified
- No regressions in existing ingestion behavior

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
