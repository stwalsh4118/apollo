# 5-5: E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI 5 Conditions of Satisfaction. This task creates comprehensive test fixtures and tests that validate the curriculum schema (positive and negative cases), the knowledge pool summary schema, the Go validation package, and reviews the research skill prompt against all acceptance criteria.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 07:11:45 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 07:33:45 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 07:38:21 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 07:58:47 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **AC 1**: Verify research skill prompt covers all 4 passes with clear instructions per pass
2. **AC 2**: Verify self-review checklist from PRD 6.1 is included in the prompt
3. **AC 3**: Verify exercise type spectrum from PRD 6.2 is documented with usage guidance
4. **AC 4**: Verify prerequisite classification rules from PRD 5.3 are included
5. **AC 5**: Verify topic splitting rules from PRD 5.4 are included
6. **AC 6**: JSON schema validates a correct, complete curriculum object (positive test with realistic fixture)
7. **AC 7**: JSON schema rejects malformed objects — missing required fields, wrong types, invalid enums (multiple negative test cases)
8. **AC 8**: Go validation function loads the schema and correctly validates/rejects JSON input
9. **AC 9**: Knowledge pool summary format documented and schema created; validates correct and rejects invalid input

## Implementation Plan

1. Create a realistic curriculum test fixture (`api/internal/schema/testdata/valid_curriculum.json`) with:
   - Complete Topic with 2+ modules
   - Modules with 2+ lessons each
   - All 6 content section types represented
   - Multiple exercise types represented
   - Concepts taught and referenced
   - Prerequisite classification with all 3 priority levels
2. Create multiple invalid fixture files for negative testing:
   - `testdata/missing_required_id.json` — topic without id
   - `testdata/invalid_difficulty.json` — topic with invalid difficulty enum
   - `testdata/missing_content_sections.json` — lesson without content sections
   - `testdata/invalid_exercise_type.json` — exercise with unknown type
3. Create knowledge pool summary test fixtures (valid and invalid)
4. Write Go integration tests in `api/internal/schema/` that use all fixtures
5. Manual review of `skills/research.md` against acceptance criteria 1-5 (documented in verification section)

## Test Plan

### Objectives
Verify all 9 acceptance criteria for PBI 5 are satisfied.

### Test Scope
- Schema validation (positive): full curriculum fixture passes validation
- Schema validation (negative): each malformed fixture produces a clear rejection
- Go validation package: `Validate()` function correctly accepts/rejects all fixtures
- Knowledge pool summary: schema accepts valid, rejects invalid
- Skill prompt review: manual checklist

### Key Scenarios
1. Valid complete curriculum → schema accepts, Go `Validate()` returns nil
2. Missing required `id` on topic → schema rejects, Go `Validate()` returns descriptive error
3. Invalid difficulty enum → schema rejects
4. Lesson with empty content sections → schema rejects
5. Exercise with unknown type → schema rejects
6. Valid knowledge pool summary (empty and populated) → schema accepts
7. Invalid knowledge pool summary (missing required fields) → schema rejects
8. Skill prompt contains all 4 pass descriptions → verified by reading file
9. Skill prompt contains self-review checklist → verified by reading file
10. Skill prompt contains all 7 exercise types → verified by reading file

### Success Criteria
- All Go tests pass
- All 9 acceptance criteria verified
- Verification section documents results for each AC

## Verification

### AC Verification Results

| AC | Description | Result |
|----|-------------|--------|
| 1 | Research skill prompt covers all 4 passes | PASS |
| 2 | Self-review checklist from PRD 6.1 (6 items) | PASS |
| 3 | Exercise type spectrum from PRD 6.2 (7 types) | PASS |
| 4 | Prerequisite classification rules (3 levels) | PASS |
| 5 | Topic splitting rules (~8 module limit) | PASS |
| 6 | JSON schema validates correct curriculum (positive) | PASS |
| 7 | JSON schema rejects malformed objects (negative) | PASS |
| 8 | Go validation function loads schema and validates | PASS |
| 9 | Knowledge pool summary schema created and tested | PASS |

### Test Results
- All 18 Go tests pass (11 E2E + 7 unit) in 0.009s
- `make check` passes (fmt, vet, test)
- Valid curriculum fixture includes all 6 content section types
- Valid curriculum fixture includes 5 distinct exercise types
- Valid curriculum fixture includes all 3 prerequisite classification levels
- Internal AI review: PASS (0 critical, 0 high, 0 medium, 2 low)

## Files Modified

- `api/internal/schema/testdata/valid_curriculum.json` (new)
- `api/internal/schema/testdata/missing_required_id.json` (new)
- `api/internal/schema/testdata/invalid_difficulty.json` (new)
- `api/internal/schema/testdata/missing_content_sections.json` (new)
- `api/internal/schema/testdata/invalid_exercise_type.json` (new)
- `api/internal/schema/testdata/valid_pool_summary.json` (new)
- `api/internal/schema/testdata/valid_pool_summary_empty.json` (new)
- `api/internal/schema/testdata/invalid_pool_summary.json` (new)
- `api/internal/schema/e2e_test.go` (new)
- `api/internal/schema/embed.go` (modified — added pool summary schema)
- `api/internal/schema/validate.go` (modified — added ValidatePoolSummary)
- `api/internal/schema/knowledge_pool_summary.json` (new — embedded copy)
