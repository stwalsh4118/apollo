# 5-4: Go Schema Validation Package

[Back to task list](./tasks.md)

## Description

Create a Go package at `api/internal/schema/` that loads the curriculum JSON Schema and validates curriculum JSON input against it. This package will be used by the research orchestrator (PBI 6) to validate structured output from Claude Code research sessions before ingesting into SQLite.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 07:11:45 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 07:28:53 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 07:33:27 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 07:58:47 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Package location: `api/internal/schema/`
2. Embed the curriculum JSON schema file using `embed.FS` (from `schemas/curriculum.json`)
3. Provide a `Validate(jsonData []byte) error` function that:
   - Loads the embedded schema (once, cached)
   - Validates the provided JSON data against the schema
   - Returns `nil` on success
   - Returns a descriptive error on failure with the specific validation error(s)
4. Clear error messages: field path + reason (e.g., "modules[0].lessons[2].content: required field 'sections' is missing")
5. Support for validating partial structures is not required — only full Topic objects
6. **External Packages**: This task requires research and a guide document for: `github.com/santhosh-tekuri/jsonschema/v6`

## Implementation Plan

1. Research `github.com/santhosh-tekuri/jsonschema/v6` — create `docs/delivery/5/5-4-jsonschema-guide.md` with API usage examples
2. Create `api/internal/schema/` package directory
3. Create `api/internal/schema/embed.go` — embed `schemas/curriculum.json` via relative path or `embed.FS`
4. Create `api/internal/schema/validate.go`:
   - `var schemaOnce sync.Once` + cached compiled schema
   - `func Validate(jsonData []byte) error` — compile schema on first call, validate input
   - Wrap validation errors with clear field-path messages
5. Create `api/internal/schema/validate_test.go`:
   - Test with a valid minimal curriculum JSON (positive)
   - Test with missing required fields (negative)
   - Test with wrong types (negative)
   - Test error messages contain field paths
6. Run `pnpm --filter api go mod tidy` or equivalent to add the dependency

## Test Plan

- `Validate()` returns nil for a valid minimal Topic JSON matching the schema
- `Validate()` returns error for JSON missing required `id` field
- `Validate()` returns error for JSON with wrong type (e.g., `estimated_hours: "not_a_number"`)
- `Validate()` returns error for invalid enum value (e.g., `difficulty: "unknown"`)
- Error messages include the field path indicating where validation failed
- Schema is loaded once and cached (no repeated parsing)

## Verification

- Validate() returns nil for valid minimal Topic JSON: PASS
- Validate() returns error for missing required id: PASS
- Validate() returns error for wrong type (string instead of number): PASS
- Validate() returns error for invalid difficulty enum: PASS
- Error messages include field paths: PASS
- Schema loaded once and cached (sync.Once): PASS
- Invalid JSON detected and reported: PASS
- `make check` passes (fmt, vet, test): PASS
- Internal AI review: PASS (0 critical, 0 high, 0 medium, 3 low)

## Files Modified

- `docs/delivery/5/5-4-jsonschema-guide.md` (new — external package research)
- `api/internal/schema/embed.go` (new)
- `api/internal/schema/validate.go` (new)
- `api/internal/schema/validate_test.go` (new)
- `api/internal/schema/curriculum.json` (new — embedded copy of schema)
- `api/go.mod` (modified — new dependency)
- `api/go.sum` (modified)
